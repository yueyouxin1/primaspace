"""initial migration up

Revision ID: baede282df95
Revises: 
Create Date: 2026-02-08 03:03:41.683771

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = 'baede282df95'
down_revision: Union[str, Sequence[str], None] = None
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('action_permissions',
    sa.Column('id', sa.Integer(), nullable=False, comment='权限唯一主键ID'),
    sa.Column('parent_id', sa.Integer(), nullable=True),
    sa.Column('name', sa.String(length=100), nullable=False, comment="权限的唯一标识符 (e.g., 'page.dashboard.view', 'project.create', 'member.invite')"),
    sa.Column('description', sa.String(length=255), nullable=True, comment='权限的详细描述'),
    sa.Column('label', sa.String(length=255), nullable=False, comment="对人类友好的名称 (e.g., '更新项目名称')"),
    sa.Column('type', sa.Enum('ABILITY', 'API', 'PAGE', 'COMPONENT', 'ACTION', name='actionpermissiontype'), nullable=False, comment='权限的作用域 (前端UI, 后端API)'),
    sa.Column('route_path', sa.String(length=255), nullable=True, comment="[前端页面] 对应的路由路径, e.g., '/dashboard'"),
    sa.Column('icon', sa.String(length=100), nullable=True, comment='[前端] 用于菜单或按钮的图标'),
    sa.Column('context_schema', sa.JSON(), nullable=True, comment='关联的context字段的JSON Schema约束'),
    sa.Column('is_assignable', sa.Boolean(), nullable=False, comment='此权限是否对团队管理员可见并可分配给自定义角色。False表示为系统内部权限。'),
    sa.ForeignKeyConstraint(['parent_id'], ['action_permissions.id'], name=op.f('fk_action_permissions_parent_id_action_permissions')),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_action_permissions')),
    sa.UniqueConstraint('name', name=op.f('uq_action_permissions_name'))
    )
    op.create_index(op.f('ix_action_permissions_parent_id'), 'action_permissions', ['parent_id'], unique=False)
    op.create_index(op.f('ix_action_permissions_type'), 'action_permissions', ['type'], unique=False)
    op.create_table('ai_knowledge_documents',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('uuid', sa.String(length=36), nullable=False),
    sa.Column('file_name', sa.String(length=255), nullable=False),
    sa.Column('file_type', sa.String(length=50), nullable=True, comment='MIME type of the file'),
    sa.Column('file_size', sa.Integer(), nullable=True, comment='File size in bytes'),
    sa.Column('source_uri', sa.String(length=1024), nullable=True, comment='URI to the original file in storage (e.g., S3)'),
    sa.Column('status', sa.Enum('PENDING', 'UPLOADING', 'PROCESSING', 'COMPLETED', 'FAILED', name='documentprocessingstatus'), nullable=False),
    sa.Column('error_message', sa.Text(), nullable=True),
    sa.Column('chunk_count', sa.Integer(), nullable=True),
    sa.Column('token_count', sa.Integer(), nullable=True),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('now()'), nullable=False),
    sa.Column('processed_at', sa.DateTime(), nullable=True),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_ai_knowledge_documents'))
    )
    op.create_index(op.f('ix_ai_knowledge_documents_status'), 'ai_knowledge_documents', ['status'], unique=False)
    op.create_index(op.f('ix_ai_knowledge_documents_uuid'), 'ai_knowledge_documents', ['uuid'], unique=True)
    op.create_table('ai_resource_categories',
    sa.Column('id', sa.Integer(), nullable=False, comment='分类唯一主键ID'),
    sa.Column('name', sa.String(length=100), nullable=False, comment='分类名称'),
    sa.Column('parent_id', sa.Integer(), nullable=True, comment='父分类ID，用于实现层级分类'),
    sa.ForeignKeyConstraint(['parent_id'], ['ai_resource_categories.id'], name=op.f('fk_ai_resource_categories_parent_id_ai_resource_categories')),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_ai_resource_categories')),
    sa.UniqueConstraint('name', name=op.f('uq_ai_resource_categories_name'))
    )
    op.create_table('ai_resource_types',
    sa.Column('id', sa.Integer(), nullable=False, comment='资源类型唯一主键ID'),
    sa.Column('name', sa.String(length=50), nullable=False, comment="类型的唯一标识符 (e.g., 'uiapp', 'tool')"),
    sa.Column('label', sa.String(length=100), nullable=True, comment="UI友好名称 (e.g., '可视化应用')"),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('is_application', sa.Boolean(), nullable=False, comment='是否可作为项目的主应用/入口资源'),
    sa.Column('meta_policy', sa.JSON(), nullable=True, comment='[补充性] 定义该类型资源行为的元策略'),
    sa.Column('allowed_visibilities', sa.JSON(), nullable=False, comment='允许的可见性选项'),
    sa.Column('allowed_channels', sa.JSON(), nullable=False, comment='允许的发布渠道'),
    sa.Column('requires_approval', sa.Boolean(), nullable=False, comment='是否需要平台审核'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_ai_resource_types')),
    sa.UniqueConstraint('name', name=op.f('uq_ai_resource_types_name'))
    )
    op.create_table('ai_workflow_node_defs',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('registry_id', sa.String(length=50), nullable=False, comment='节点全局唯一标识'),
    sa.Column('category', sa.String(length=50), nullable=False),
    sa.Column('icon', sa.String(length=255), nullable=True),
    sa.Column('display_order', sa.Integer(), nullable=True),
    sa.Column('data', sa.JSON(), nullable=False, comment='节点的预设数据结构 (NodeData)'),
    sa.Column('forms', sa.JSON(), nullable=False, comment='节点的 UI 表单定义'),
    sa.Column('is_active', sa.Boolean(), nullable=True),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_ai_workflow_node_defs'))
    )
    op.create_index(op.f('ix_ai_workflow_node_defs_category'), 'ai_workflow_node_defs', ['category'], unique=False)
    op.create_index(op.f('ix_ai_workflow_node_defs_registry_id'), 'ai_workflow_node_defs', ['registry_id'], unique=True)
    op.create_table('assets_intelligence',
    sa.Column('content_hash', sa.String(length=128), nullable=False, comment='文件内容权威Hash (通常为OSS ETag)'),
    sa.Column('status', sa.Enum('PENDING', 'PROCESSING', 'COMPLETED', 'FAILED', name='intelligencestatus'), nullable=False),
    sa.Column('meta', sa.JSON(), nullable=True, comment='AI分析结果'),
    sa.Column('is_vector_indexed', sa.Boolean(), nullable=True),
    sa.Column('updated_at', sa.DateTime(), server_default=sa.text('now()'), nullable=True),
    sa.PrimaryKeyConstraint('content_hash', name=op.f('pk_assets_intelligence'))
    )
    op.create_index(op.f('ix_assets_intelligence_is_vector_indexed'), 'assets_intelligence', ['is_vector_indexed'], unique=False)
    op.create_table('billing_accounts',
    sa.Column('id', sa.Integer(), nullable=False, comment='计费账户唯一主键ID'),
    sa.Column('uuid', sa.String(length=36), nullable=False, comment='计费账户的全局唯一标识符'),
    sa.Column('balance', sa.DECIMAL(precision=18, scale=8), nullable=False, comment='账户余额，使用DECIMAL保证财务计算精度'),
    sa.Column('currency', sa.Enum('CNY', 'USD', 'EUR', 'JPY', 'GBP', name='currency'), nullable=False, comment="ISO 4217 code of the account's base currency"),
    sa.Column('status', sa.Enum('ACTIVE', 'DELINQUENT', 'SUSPENDED', 'CLOSED', name='accountstatus'), nullable=False),
    sa.Column('customer_id', sa.String(length=255), nullable=True, comment='在支付网关的客户ID'),
    sa.Column('subscription_id', sa.String(length=255), nullable=True, comment='在支付网关的订阅ID'),
    sa.Column('subscription_status', sa.String(length=50), nullable=True, comment='订阅状态'),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(), server_default=sa.text('now()'), nullable=False),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_billing_accounts'))
    )
    op.create_index(op.f('ix_billing_accounts_status'), 'billing_accounts', ['status'], unique=False)
    op.create_index(op.f('ix_billing_accounts_uuid'), 'billing_accounts', ['uuid'], unique=True)
    op.create_table('payment_gateways',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=50), nullable=False, comment="e.g., 'stripe', 'alipay', 'wechat_pay'"),
    sa.Column('label', sa.String(length=100), nullable=False, comment="e.g., 'Stripe', '支付宝', '微信支付'"),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_payment_gateways')),
    sa.UniqueConstraint('name', name=op.f('uq_payment_gateways_name'))
    )
    op.create_table('service_module_providers',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=100), nullable=False, comment="提供商的唯一标识符, e.g., 'openai', 'aliyun'"),
    sa.Column('label', sa.String(length=255), nullable=False, comment="UI上显示的名称, e.g., 'OpenAI', '阿里云通义'"),
    sa.Column('description', sa.Text(), nullable=True),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_service_module_providers')),
    sa.UniqueConstraint('name', name=op.f('uq_service_module_providers_name'))
    )
    op.create_table('service_module_types',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=50), nullable=False, comment="类型的唯一标识符 (e.g., 'llm', 'tts', 'image_generation', 'code_interpreter')"),
    sa.Column('label', sa.String(length=100), nullable=False, comment="UI上显示的名称 (e.g., '大型语言模型', '语音合成')"),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('default_version_id', sa.Integer(), nullable=True),
    sa.ForeignKeyConstraint(['default_version_id'], ['service_module_versions.id'], name=op.f('fk_service_module_types_default_version_id_service_module_versions'), ondelete='SET NULL', use_alter=True),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_service_module_types')),
    sa.UniqueConstraint('name', name=op.f('uq_service_module_types_name'))
    )
    op.create_table('ai_knowledge_chunks',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('uuid', sa.String(length=36), nullable=False),
    sa.Column('document_id', sa.Integer(), nullable=False),
    sa.Column('content', sa.Text(), nullable=False),
    sa.Column('token_count', sa.Integer(), nullable=False),
    sa.Column('vector_id', sa.String(length=255), nullable=True, comment='The unique ID of this chunk in the physical vector store'),
    sa.Column('context', sa.JSON(), nullable=True, comment='Structured context for enrichment (e.g., page number, section)'),
    sa.Column('payload', sa.JSON(), nullable=True, comment='Vector payload'),
    sa.Column('status', sa.Enum('PENDING', 'COMPLETED', 'FAILED', name='chunkprocessingstatus'), nullable=False),
    sa.Column('error_message', sa.Text(), nullable=True),
    sa.ForeignKeyConstraint(['document_id'], ['ai_knowledge_documents.id'], name=op.f('fk_ai_knowledge_chunks_document_id_ai_knowledge_documents'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_ai_knowledge_chunks'))
    )
    op.create_index(op.f('ix_ai_knowledge_chunks_document_id'), 'ai_knowledge_chunks', ['document_id'], unique=False)
    op.create_index(op.f('ix_ai_knowledge_chunks_status'), 'ai_knowledge_chunks', ['status'], unique=False)
    op.create_index(op.f('ix_ai_knowledge_chunks_uuid'), 'ai_knowledge_chunks', ['uuid'], unique=True)
    op.create_index(op.f('ix_ai_knowledge_chunks_vector_id'), 'ai_knowledge_chunks', ['vector_id'], unique=False)
    op.create_table('payment_methods',
    sa.Column('id', sa.Integer(), nullable=False, comment='所有支付方式的全局唯一主键ID'),
    sa.Column('billing_account_id', sa.Integer(), nullable=False, comment='所属的计费账户ID'),
    sa.Column('gateway_id', sa.Integer(), nullable=False, comment='所使用的支付网关ID'),
    sa.Column('is_default', sa.Boolean(), nullable=False, comment='是否为该账户的默认支付方式'),
    sa.Column('label', sa.String(length=100), nullable=True, comment="用户为此支付方式设置的别名 (e.g., '公司招行卡')"),
    sa.Column('is_active', sa.Boolean(), nullable=False, comment='该支付方式是否可用'),
    sa.Column('gateway_type', sa.String(length=50), nullable=False, comment="多态鉴别器 (e.g., 'wechat_pay', 'alipay'),其值来自payment_gateways->name"),
    sa.ForeignKeyConstraint(['billing_account_id'], ['billing_accounts.id'], name=op.f('fk_payment_methods_billing_account_id_billing_accounts'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['gateway_id'], ['payment_gateways.id'], name=op.f('fk_payment_methods_gateway_id_payment_gateways')),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_payment_methods'))
    )
    op.create_index(op.f('ix_payment_methods_billing_account_id'), 'payment_methods', ['billing_account_id'], unique=False)
    op.create_index(op.f('ix_payment_methods_is_default'), 'payment_methods', ['is_default'], unique=False)
    op.create_table('service_modules',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('uuid', sa.String(length=36), nullable=False),
    sa.Column('type_id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=100), nullable=False, comment="服务模块的唯一名称 (e.g., 'gpt-4-turbo', 'deepgram-nova-2')"),
    sa.Column('label', sa.String(length=255), nullable=False, comment='UI上显示的名称'),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('provider_id', sa.Integer(), nullable=False),
    sa.Column('requires_credential', sa.Boolean(), nullable=False, comment='是否必须提供用户凭证才能执行'),
    sa.Column('latest_version_id', sa.Integer(), nullable=True),
    sa.Column('permission_id', sa.Integer(), nullable=False),
    sa.ForeignKeyConstraint(['latest_version_id'], ['service_module_versions.id'], name=op.f('fk_service_modules_latest_version_id_service_module_versions'), ondelete='SET NULL', use_alter=True),
    sa.ForeignKeyConstraint(['permission_id'], ['action_permissions.id'], name=op.f('fk_service_modules_permission_id_action_permissions'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['provider_id'], ['service_module_providers.id'], name=op.f('fk_service_modules_provider_id_service_module_providers')),
    sa.ForeignKeyConstraint(['type_id'], ['service_module_types.id'], name=op.f('fk_service_modules_type_id_service_module_types')),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_service_modules')),
    sa.UniqueConstraint('name', name=op.f('uq_service_modules_name')),
    sa.UniqueConstraint('permission_id', name=op.f('uq_service_modules_permission_id'))
    )
    op.create_index(op.f('ix_service_modules_provider_id'), 'service_modules', ['provider_id'], unique=False)
    op.create_index(op.f('ix_service_modules_uuid'), 'service_modules', ['uuid'], unique=True)
    op.create_table('users',
    sa.Column('id', sa.Integer(), nullable=False, comment='用户唯一主键ID'),
    sa.Column('uuid', sa.String(length=36), nullable=False, comment='用户的全局唯一标识符，用于API暴露'),
    sa.Column('email', sa.String(length=255), nullable=True, comment='用户邮箱，用于登录和通知，唯一'),
    sa.Column('phone_number', sa.String(length=20), nullable=True, comment='用户手机号，用于登录和通知，唯一'),
    sa.Column('password_hash', sa.String(length=255), nullable=True, comment='哈希后的用户密码，允许为空以支持无密码/待激活状态'),
    sa.Column('nick_name', sa.String(length=100), nullable=True, comment='用户昵称'),
    sa.Column('avatar', sa.String(length=512), nullable=True, comment='用户头像URL'),
    sa.Column('status', sa.Enum('PENDING', 'ACTIVE', 'SUSPENDED', name='userstatus'), nullable=False, comment='用户账户状态 (待激活, 活跃, 禁用)'),
    sa.Column('user_type', sa.Enum('REGULAR', 'MANAGED', name='usertype'), nullable=False, comment='用户账户类型 (普通用户, 被管理子账户)'),
    sa.Column('managing_entity_type', sa.String(length=50), nullable=True, comment="当user_type为MANAGED时，管理该账户的实体类型 (e.g., 'team')"),
    sa.Column('managing_entity_id', sa.Integer(), nullable=True, comment='当user_type为MANAGED时，管理该账户的实体ID'),
    sa.Column('external_idp', sa.String(length=50), nullable=True, comment="身份提供商标识, e.g., 'okta', 'azure_ad'"),
    sa.Column('external_id', sa.String(length=255), nullable=True, comment='在外部IdP中的唯一ID'),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('now()'), nullable=False, comment='账户创建时间'),
    sa.Column('updated_at', sa.DateTime(), server_default=sa.text('now()'), nullable=False, comment='账户信息最后更新时间'),
    sa.Column('last_login_at', sa.DateTime(), nullable=True, comment='用户最后登录时间'),
    sa.Column('billing_account_id', sa.Integer(), nullable=False, comment='关联的个人计费账户ID'),
    sa.ForeignKeyConstraint(['billing_account_id'], ['billing_accounts.id'], name=op.f('fk_users_billing_account_id_billing_accounts')),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_users'))
    )
    op.create_index(op.f('ix_users_billing_account_id'), 'users', ['billing_account_id'], unique=True)
    op.create_index(op.f('ix_users_email'), 'users', ['email'], unique=True)
    op.create_index(op.f('ix_users_managing_entity_id'), 'users', ['managing_entity_id'], unique=False)
    op.create_index(op.f('ix_users_phone_number'), 'users', ['phone_number'], unique=True)
    op.create_index(op.f('ix_users_uuid'), 'users', ['uuid'], unique=True)
    op.create_table('payment_methods_alipay',
    sa.Column('payment_method_id', sa.Integer(), nullable=False),
    sa.Column('gateway_customer_id', sa.String(length=255), nullable=False, comment='该用户在支付网关的客户ID'),
    sa.Column('gateway_payment_method_id', sa.String(length=255), nullable=False, comment='该支付宝账户在支付网关的唯一ID'),
    sa.Column('alipay_user_id', sa.String(length=100), nullable=True, comment='用户的支付宝ID (脱敏后)'),
    sa.ForeignKeyConstraint(['payment_method_id'], ['payment_methods.id'], name=op.f('fk_payment_methods_alipay_payment_method_id_payment_methods'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('payment_method_id', name=op.f('pk_payment_methods_alipay')),
    sa.UniqueConstraint('gateway_payment_method_id', name=op.f('uq_payment_methods_alipay_gateway_payment_method_id'))
    )
    op.create_table('payment_methods_credit_card',
    sa.Column('payment_method_id', sa.Integer(), nullable=False, comment='主键，同时是到父表的外键'),
    sa.Column('gateway_customer_id', sa.String(length=255), nullable=False, comment="该用户在支付网关的客户ID (e.g., Stripe's cus_...)"),
    sa.Column('gateway_payment_method_id', sa.String(length=255), nullable=False, comment="该卡在支付网关的唯一ID (e.g., Stripe's pm_...)"),
    sa.Column('brand', sa.String(length=50), nullable=True, comment="卡品牌 (e.g., 'Visa', 'Mastercard')"),
    sa.Column('last4', sa.String(length=4), nullable=True, comment='卡号末四位'),
    sa.Column('exp_month', sa.Integer(), nullable=True, comment='过期月份'),
    sa.Column('exp_year', sa.Integer(), nullable=True, comment='过期年份'),
    sa.ForeignKeyConstraint(['payment_method_id'], ['payment_methods.id'], name=op.f('fk_payment_methods_credit_card_payment_method_id_payment_methods'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('payment_method_id', name=op.f('pk_payment_methods_credit_card')),
    sa.UniqueConstraint('gateway_payment_method_id', name=op.f('uq_payment_methods_credit_card_gateway_payment_method_id'))
    )
    op.create_table('service_module_versions',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('uuid', sa.String(length=36), nullable=False),
    sa.Column('service_module_id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=100), nullable=False, comment="此版本的唯一名称 (e.g., 'qwen-plus-latest', 'gpt-4-turbo-2024-04-09')"),
    sa.Column('description', sa.Text(), nullable=True, comment='此版本的描述'),
    sa.Column('version_tag', sa.String(length=100), nullable=False, comment="版本的唯一标识符 (e.g., '2024-04-09', 'v2.1.0')"),
    sa.Column('version_notes', sa.Text(), nullable=True, comment='版本更新说明'),
    sa.Column('status', sa.Enum('AVAILABLE', 'BETA', 'DEPRECATED', 'UNAVAILABLE', name='servicemodulestatus'), nullable=False),
    sa.Column('availability_regions', sa.JSON(), nullable=True, comment="[可选] 可用区域列表 (e.g., ['us-east-1', 'eu-west-1'])"),
    sa.Column('config', sa.JSON(), nullable=True, comment='[Pydantic-driven] The default configuration object, serialized from the authoritative Pydantic model.'),
    sa.Column('attributes', sa.JSON(), nullable=True, comment='[Pydantic-driven] The immutable specifications object, serialized from the authoritative Pydantic model.'),
    sa.Column('release_date', sa.DateTime(), nullable=True),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['service_module_id'], ['service_modules.id'], name=op.f('fk_service_module_versions_service_module_id_service_modules'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_service_module_versions')),
    sa.UniqueConstraint('name', name=op.f('uq_service_module_versions_name')),
    sa.UniqueConstraint('service_module_id', 'version_tag', name='uq_service_module_version')
    )
    op.create_index(op.f('ix_service_module_versions_service_module_id'), 'service_module_versions', ['service_module_id'], unique=False)
    op.create_index(op.f('ix_service_module_versions_status'), 'service_module_versions', ['status'], unique=False)
    op.create_index(op.f('ix_service_module_versions_uuid'), 'service_module_versions', ['uuid'], unique=True)
    op.create_table('teams',
    sa.Column('id', sa.Integer(), nullable=False, comment='团队唯一主键ID'),
    sa.Column('uuid', sa.String(length=36), nullable=False, comment='团队的全局唯一标识符'),
    sa.Column('name', sa.String(length=255), nullable=False, comment='团队名称'),
    sa.Column('avatar', sa.String(length=512), nullable=True, comment='团队头像URL'),
    sa.Column('owner_id', sa.Integer(), nullable=False, comment='团队所有者的用户ID，最终财务责任人'),
    sa.Column('billing_account_id', sa.Integer(), nullable=False, comment='关联的团队计费账户ID'),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('now()'), nullable=False, comment='团队创建时间'),
    sa.Column('updated_at', sa.DateTime(), server_default=sa.text('now()'), nullable=False, comment='团队信息最后更新时间'),
    sa.ForeignKeyConstraint(['billing_account_id'], ['billing_accounts.id'], name=op.f('fk_teams_billing_account_id_billing_accounts')),
    sa.ForeignKeyConstraint(['owner_id'], ['users.id'], name=op.f('fk_teams_owner_id_users')),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_teams')),
    sa.UniqueConstraint('billing_account_id', name=op.f('uq_teams_billing_account_id'))
    )
    op.create_index(op.f('ix_teams_uuid'), 'teams', ['uuid'], unique=True)
    op.create_table('ai_workspaces',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('uuid', sa.String(length=36), nullable=False),
    sa.Column('name', sa.String(length=255), nullable=False),
    sa.Column('avatar', sa.String(length=512), nullable=True, comment='工作空间头像URL'),
    sa.Column('owner_user_id', sa.Integer(), nullable=True),
    sa.Column('owner_team_id', sa.Integer(), nullable=True),
    sa.Column('status', sa.Enum('ACTIVE', 'SUSPENDED', 'ARCHIVED', name='workspacestatus'), nullable=False, comment='工作空间状态 (活跃, 暂停, 归档)'),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('now()'), nullable=False),
    sa.Column('asset_config', sa.JSON(), nullable=True, comment='素材库策略配置'),
    sa.CheckConstraint('(owner_user_id IS NOT NULL AND owner_team_id IS NULL) OR (owner_user_id IS NULL AND owner_team_id IS NOT NULL)', name=op.f('ck_ai_workspaces_ck_workspace_owner_exclusive')),
    sa.ForeignKeyConstraint(['owner_team_id'], ['teams.id'], name=op.f('fk_ai_workspaces_owner_team_id_teams')),
    sa.ForeignKeyConstraint(['owner_user_id'], ['users.id'], name=op.f('fk_ai_workspaces_owner_user_id_users')),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_ai_workspaces'))
    )
    op.create_index(op.f('ix_ai_workspaces_owner_team_id'), 'ai_workspaces', ['owner_team_id'], unique=False)
    op.create_index(op.f('ix_ai_workspaces_owner_user_id'), 'ai_workspaces', ['owner_user_id'], unique=False)
    op.create_index(op.f('ix_ai_workspaces_uuid'), 'ai_workspaces', ['uuid'], unique=True)
    op.create_table('api_keys',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('key_prefix', sa.String(length=8), nullable=False, comment="可安全显示的前缀, e.g., 'sk-...'"),
    sa.Column('key_hash', sa.String(length=255), nullable=False, comment='哈希后的完整密钥'),
    sa.Column('owner_user_id', sa.Integer(), nullable=True),
    sa.Column('owner_team_id', sa.Integer(), nullable=True),
    sa.Column('description', sa.String(length=255), nullable=True),
    sa.Column('expires_at', sa.DateTime(), nullable=True),
    sa.Column('last_used_at', sa.DateTime(), nullable=True),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(), server_default=sa.text('now()'), nullable=False),
    sa.CheckConstraint('(owner_user_id IS NOT NULL AND owner_team_id IS NULL) OR (owner_user_id IS NULL AND owner_team_id IS NOT NULL)', name=op.f('ck_api_keys_ck_apikey_owner_exclusive')),
    sa.ForeignKeyConstraint(['owner_team_id'], ['teams.id'], name=op.f('fk_api_keys_owner_team_id_teams'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['owner_user_id'], ['users.id'], name=op.f('fk_api_keys_owner_user_id_users'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_api_keys')),
    sa.UniqueConstraint('key_hash', name=op.f('uq_api_keys_key_hash')),
    sa.UniqueConstraint('key_prefix', name=op.f('uq_api_keys_key_prefix'))
    )
    op.create_table('features',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=255), nullable=False, comment="功能的唯一标识符 (e.g., 'llm:tokens:input:openai:gpt-4o-2024-05-13', 'storage:5gb_month')"),
    sa.Column('label', sa.String(length=255), nullable=False, comment="UI上显示的名称 (e.g., 'GPT-4o 输入Token', '每月存储空间(GB)')"),
    sa.Column('type', sa.Enum('QUOTA', 'METERED', name='featuretype'), nullable=False, comment='功能类型'),
    sa.Column('feature_role', sa.String(length=50), nullable=True, comment='定义Feature在不同场景中扮演的角色'),
    sa.Column('is_active', sa.Boolean(), nullable=False, comment='该单元当前是否可用'),
    sa.Column('service_module_version_id', sa.Integer(), nullable=True),
    sa.Column('permission_id', sa.Integer(), nullable=True),
    sa.ForeignKeyConstraint(['permission_id'], ['action_permissions.id'], name=op.f('fk_features_permission_id_action_permissions'), ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['service_module_version_id'], ['service_module_versions.id'], name=op.f('fk_features_service_module_version_id_service_module_versions'), ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_features')),
    sa.UniqueConstraint('name', name=op.f('uq_features_name')),
    sa.UniqueConstraint('permission_id', name=op.f('uq_features_permission_id')),
    sa.UniqueConstraint('service_module_version_id', 'feature_role', name='uq_smv_feature_role')
    )
    op.create_index(op.f('ix_features_service_module_version_id'), 'features', ['service_module_version_id'], unique=False)
    op.create_table('service_module_dependencies',
    sa.Column('dependant_version_id', sa.Integer(), nullable=False, comment='依赖方 (Dependant) 的服务模块版本ID'),
    sa.Column('dependency_version_id', sa.Integer(), nullable=False, comment='被依赖方 (Dependency) 的服务模块版本ID'),
    sa.Column('is_hard_dependency', sa.Boolean(), nullable=True, comment='是否是硬依赖。若为False，表示为可选或推荐依赖。'),
    sa.ForeignKeyConstraint(['dependant_version_id'], ['service_module_versions.id'], name=op.f('fk_service_module_dependencies_dependant_version_id_service_module_versions'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['dependency_version_id'], ['service_module_versions.id'], name=op.f('fk_service_module_dependencies_dependency_version_id_service_module_versions'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('dependant_version_id', 'dependency_version_id', name=op.f('pk_service_module_dependencies'))
    )
    op.create_table('ai_api_policies',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=255), nullable=False),
    sa.Column('workspace_id', sa.Integer(), nullable=False),
    sa.Column('auth_type', sa.Enum('NONE', 'API_KEY', name='authtype'), nullable=False),
    sa.Column('rate_limit_per_minute', sa.Integer(), nullable=True),
    sa.ForeignKeyConstraint(['workspace_id'], ['ai_workspaces.id'], name=op.f('fk_ai_api_policies_workspace_id_ai_workspaces'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_ai_api_policies'))
    )
    op.create_table('ai_projects',
    sa.Column('id', sa.Integer(), nullable=False, comment='项目唯一主键ID'),
    sa.Column('uuid', sa.String(length=36), nullable=False, comment='项目的全局唯一标识符'),
    sa.Column('workspace_id', sa.Integer(), nullable=False, comment='所属工作空间ID'),
    sa.Column('creator_id', sa.Integer(), nullable=False, comment='项目创建者的用户ID'),
    sa.Column('name', sa.String(length=255), nullable=False, comment='项目名称'),
    sa.Column('description', sa.Text(), nullable=True, comment='项目描述'),
    sa.Column('avatar', sa.String(length=512), nullable=True, comment='项目图标URL'),
    sa.Column('env_config', sa.JSON(), nullable=False, comment='项目级环境配置 (运行时可选注入)'),
    sa.Column('main_resource_id', sa.Integer(), nullable=True, comment='项目的主资源/入口资源ID'),
    sa.Column('visibility', sa.Enum('PRIVATE', 'WORKSPACE', 'PUBLIC', name='projectvisibility'), nullable=False, comment='项目可见性 (私有, 工作空间, 公开)'),
    sa.Column('status', sa.Enum('DRAFT', 'ACTIVE', 'ARCHIVED', 'TEMPLATE', name='projectstatus'), nullable=False, comment='项目状态 (草稿, 活跃, 归档, 模板)'),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('now()'), nullable=False, comment='项目创建时间'),
    sa.Column('updated_at', sa.DateTime(), server_default=sa.text('now()'), nullable=False, comment='项目信息最后更新时间'),
    sa.ForeignKeyConstraint(['creator_id'], ['users.id'], name=op.f('fk_ai_projects_creator_id_users')),
    sa.ForeignKeyConstraint(['main_resource_id'], ['ai_resources.id'], name=op.f('fk_ai_projects_main_resource_id_ai_resources'), ondelete='SET NULL', use_alter=True),
    sa.ForeignKeyConstraint(['workspace_id'], ['ai_workspaces.id'], name=op.f('fk_ai_projects_workspace_id_ai_workspaces'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_ai_projects'))
    )
    op.create_index(op.f('ix_ai_projects_uuid'), 'ai_projects', ['uuid'], unique=True)
    op.create_index(op.f('ix_ai_projects_workspace_id'), 'ai_projects', ['workspace_id'], unique=False)
    op.create_table('ai_resources',
    sa.Column('id', sa.Integer(), nullable=False, comment='资源唯一主键ID'),
    sa.Column('uuid', sa.String(length=36), nullable=False, comment='资源的全局唯一标识符'),
    sa.Column('workspace_id', sa.Integer(), nullable=False, comment='所属工作空间ID'),
    sa.Column('resource_type_id', sa.Integer(), nullable=False, comment='资源类型ID'),
    sa.Column('category_id', sa.Integer(), nullable=True, comment='资源分类ID'),
    sa.Column('name', sa.String(length=255), nullable=False, comment='资源的当前名称'),
    sa.Column('description', sa.Text(), nullable=True, comment='资源的当前描述'),
    sa.Column('avatar', sa.String(length=512), nullable=True, comment='资源图标URL'),
    sa.Column('status', sa.Enum('ACTIVE', 'SUSPENDED', 'ARCHIVED', name='resourcestatus'), nullable=False, comment='平台级的资源总开关 (活跃, 暂停, 归档)'),
    sa.Column('heat_value', sa.Integer(), nullable=False, comment='热度值，用于排序和推荐'),
    sa.Column('workspace_instance_id', sa.Integer(), nullable=True),
    sa.Column('latest_published_instance_id', sa.Integer(), nullable=True),
    sa.Column('creator_id', sa.Integer(), nullable=False, comment='资源创建者的用户ID'),
    sa.Column('last_modifier_id', sa.Integer(), nullable=True, comment='最后修改者的用户ID'),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('now()'), nullable=False, comment='资源创建时间'),
    sa.Column('updated_at', sa.DateTime(), server_default=sa.text('now()'), nullable=False, comment='资源最后更新时间'),
    sa.ForeignKeyConstraint(['category_id'], ['ai_resource_categories.id'], name=op.f('fk_ai_resources_category_id_ai_resource_categories')),
    sa.ForeignKeyConstraint(['creator_id'], ['users.id'], name=op.f('fk_ai_resources_creator_id_users')),
    sa.ForeignKeyConstraint(['last_modifier_id'], ['users.id'], name=op.f('fk_ai_resources_last_modifier_id_users')),
    sa.ForeignKeyConstraint(['latest_published_instance_id'], ['ai_resource_instances.id'], name=op.f('fk_ai_resources_latest_published_instance_id_ai_resource_instances'), ondelete='SET NULL', use_alter=True),
    sa.ForeignKeyConstraint(['resource_type_id'], ['ai_resource_types.id'], name=op.f('fk_ai_resources_resource_type_id_ai_resource_types')),
    sa.ForeignKeyConstraint(['workspace_id'], ['ai_workspaces.id'], name=op.f('fk_ai_resources_workspace_id_ai_workspaces'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['workspace_instance_id'], ['ai_resource_instances.id'], name=op.f('fk_ai_resources_workspace_instance_id_ai_resource_instances'), ondelete='SET NULL', use_alter=True),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_ai_resources'))
    )
    op.create_index(op.f('ix_ai_resources_category_id'), 'ai_resources', ['category_id'], unique=False)
    op.create_index(op.f('ix_ai_resources_heat_value'), 'ai_resources', ['heat_value'], unique=False)
    op.create_index(op.f('ix_ai_resources_resource_type_id'), 'ai_resources', ['resource_type_id'], unique=False)
    op.create_index(op.f('ix_ai_resources_uuid'), 'ai_resources', ['uuid'], unique=True)
    op.create_index(op.f('ix_ai_resources_workspace_id'), 'ai_resources', ['workspace_id'], unique=False)
    op.create_table('assets_folders',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('uuid', sa.String(length=36), nullable=False),
    sa.Column('workspace_id', sa.Integer(), nullable=False),
    sa.Column('creator_id', sa.Integer(), nullable=True),
    sa.Column('parent_id', sa.Integer(), nullable=True),
    sa.Column('name', sa.String(length=255), nullable=False),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(), server_default=sa.text('now()'), nullable=False),
    sa.Column('is_deleted', sa.Boolean(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['creator_id'], ['users.id'], name=op.f('fk_assets_folders_creator_id_users')),
    sa.ForeignKeyConstraint(['parent_id'], ['assets_folders.id'], name=op.f('fk_assets_folders_parent_id_assets_folders'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['workspace_id'], ['ai_workspaces.id'], name=op.f('fk_assets_folders_workspace_id_ai_workspaces'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_assets_folders'))
    )
    op.create_index(op.f('ix_assets_folders_is_deleted'), 'assets_folders', ['is_deleted'], unique=False)
    op.create_index(op.f('ix_assets_folders_parent_id'), 'assets_folders', ['parent_id'], unique=False)
    op.create_index(op.f('ix_assets_folders_uuid'), 'assets_folders', ['uuid'], unique=True)
    op.create_index(op.f('ix_assets_folders_workspace_id'), 'assets_folders', ['workspace_id'], unique=False)
    op.create_table('roles',
    sa.Column('id', sa.Integer(), nullable=False, comment='角色唯一主键ID'),
    sa.Column('uuid', sa.String(length=36), nullable=False),
    sa.Column('parent_id', sa.Integer(), nullable=True),
    sa.Column('name', sa.String(length=100), nullable=False, comment='角色名称 (e.g., Owner, Admin, Editor, Viewer)'),
    sa.Column('label', sa.String(length=255), nullable=False, comment='角色别名'),
    sa.Column('description', sa.String(length=255), nullable=True, comment='角色的详细描述'),
    sa.Column('role_type', sa.Enum('SYSTEM_PLAN', 'SYSTEM_TEAM_TEMPLATE', 'CUSTOM_TEAM', name='roletype'), nullable=False),
    sa.Column('team_id', sa.Integer(), nullable=True, comment='所属团队ID, 为NULL表示是系统级预设角色'),
    sa.Column('workspace_id', sa.Integer(), nullable=True, comment='所属工作空间ID，用于更细粒度的权限'),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.ForeignKeyConstraint(['parent_id'], ['roles.id'], name=op.f('fk_roles_parent_id_roles')),
    sa.ForeignKeyConstraint(['team_id'], ['teams.id'], name=op.f('fk_roles_team_id_teams'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['workspace_id'], ['ai_workspaces.id'], name=op.f('fk_roles_workspace_id_ai_workspaces'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_roles'))
    )
    op.create_index(op.f('ix_roles_parent_id'), 'roles', ['parent_id'], unique=False)
    op.create_index(op.f('ix_roles_uuid'), 'roles', ['uuid'], unique=True)
    op.create_table('service_module_credentials',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('uuid', sa.String(length=36), nullable=False),
    sa.Column('provider_id', sa.Integer(), nullable=False),
    sa.Column('label', sa.String(length=255), nullable=True, comment="e.g., 'My Company OpenAI Key'"),
    sa.Column('encrypted_value', sa.Text(), nullable=False),
    sa.Column('encrypted_endpoint', sa.Text(), nullable=True, comment='[可选] 加密后的API端点URL'),
    sa.Column('region', sa.String(length=100), nullable=True, comment='[可选] 服务区域'),
    sa.Column('attributes', sa.JSON(), nullable=True, comment='[可选] 其他提供商特定的、非敏感的元数据'),
    sa.Column('workspace_id', sa.Integer(), nullable=False),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['provider_id'], ['service_module_providers.id'], name=op.f('fk_service_module_credentials_provider_id_service_module_providers')),
    sa.ForeignKeyConstraint(['workspace_id'], ['ai_workspaces.id'], name=op.f('fk_service_module_credentials_workspace_id_ai_workspaces'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_service_module_credentials')),
    sa.UniqueConstraint('workspace_id', 'provider_id', name='uq_workspace_provider_credential')
    )
    op.create_index(op.f('ix_service_module_credentials_provider_id'), 'service_module_credentials', ['provider_id'], unique=False)
    op.create_index(op.f('ix_service_module_credentials_uuid'), 'service_module_credentials', ['uuid'], unique=True)
    op.create_index(op.f('ix_service_module_credentials_workspace_id'), 'service_module_credentials', ['workspace_id'], unique=False)
    op.create_table('activity_logs',
    sa.Column('id', sa.Integer(), nullable=False, comment='日志唯一主键ID'),
    sa.Column('parent_id', sa.Integer(), nullable=True, comment='父行为ID。用于将交互事件关联到其所属的页面浏览事件。'),
    sa.Column('actor_user_id', sa.Integer(), nullable=True, comment='执行操作的用户ID'),
    sa.Column('actor_team_id', sa.Integer(), nullable=True, comment='用户执行操作时所在的团队上下文ID'),
    sa.Column('actor_ip_address', sa.String(length=45), nullable=True, comment='操作者的IP地址'),
    sa.Column('action_id', sa.Integer(), nullable=False, comment='执行的动作ID，关联到权威的action_permissions表'),
    sa.Column('acting_role_id', sa.Integer(), nullable=True, comment='[快照指针] 执行此操作时，用户所扮演的角色的ID'),
    sa.Column('acting_role_name', sa.String(length=100), nullable=True, comment='[快照值] 执行此操作时，角色的名称（冗余，用于快速审计）'),
    sa.Column('target_action_name', sa.String(length=100), nullable=True, comment='[快照值] 此操作目标动作权限名称'),
    sa.Column('status_code', sa.Integer(), nullable=True, comment='操作的结果状态码 (e.g., 200 for success, 403 for forbidden)'),
    sa.Column('context', sa.JSON(), nullable=True, comment="与行为相关的附加上下文信息 (e.g., 'page_url': '/projects/123/edit', 'search_term': 'weather')"),
    sa.Column('timestamp', sa.DateTime(), server_default=sa.text('now()'), nullable=False, comment='行为发生的时间戳'),
    sa.ForeignKeyConstraint(['acting_role_id'], ['roles.id'], name=op.f('fk_activity_logs_acting_role_id_roles'), ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['action_id'], ['action_permissions.id'], name=op.f('fk_activity_logs_action_id_action_permissions')),
    sa.ForeignKeyConstraint(['actor_team_id'], ['teams.id'], name=op.f('fk_activity_logs_actor_team_id_teams'), ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['actor_user_id'], ['users.id'], name=op.f('fk_activity_logs_actor_user_id_users'), ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['parent_id'], ['activity_logs.id'], name=op.f('fk_activity_logs_parent_id_activity_logs'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_activity_logs'))
    )
    op.create_index(op.f('ix_activity_logs_action_id'), 'activity_logs', ['action_id'], unique=False)
    op.create_index(op.f('ix_activity_logs_actor_team_id'), 'activity_logs', ['actor_team_id'], unique=False)
    op.create_index(op.f('ix_activity_logs_actor_user_id'), 'activity_logs', ['actor_user_id'], unique=False)
    op.create_index(op.f('ix_activity_logs_parent_id'), 'activity_logs', ['parent_id'], unique=False)
    op.create_index(op.f('ix_activity_logs_timestamp'), 'activity_logs', ['timestamp'], unique=False)
    op.create_table('ai_project_resource_refs',
    sa.Column('id', sa.Integer(), nullable=False, comment='项目资源引用唯一主键ID'),
    sa.Column('project_id', sa.Integer(), nullable=False, comment='项目ID'),
    sa.Column('resource_id', sa.Integer(), nullable=False, comment='资源ID'),
    sa.Column('alias', sa.String(length=255), nullable=True, comment='项目内别名'),
    sa.Column('options', sa.JSON(), nullable=True, comment='项目级引用配置'),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('now()'), nullable=False, comment='引用创建时间'),
    sa.ForeignKeyConstraint(['project_id'], ['ai_projects.id'], name=op.f('fk_ai_project_resource_refs_project_id_ai_projects'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['resource_id'], ['ai_resources.id'], name=op.f('fk_ai_project_resource_refs_resource_id_ai_resources'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_ai_project_resource_refs')),
    sa.UniqueConstraint('project_id', 'resource_id', name='uq_project_resource')
    )
    op.create_index(op.f('ix_ai_project_resource_refs_project_id'), 'ai_project_resource_refs', ['project_id'], unique=False)
    op.create_index(op.f('ix_ai_project_resource_refs_resource_id'), 'ai_project_resource_refs', ['resource_id'], unique=False)
    op.create_table('ai_resource_instances',
    sa.Column('id', sa.Integer(), nullable=False, comment='版本实体的唯一ID (version_id)'),
    sa.Column('uuid', sa.String(length=36), nullable=False),
    sa.Column('parent_version_id', sa.Integer(), nullable=True),
    sa.Column('resource_id', sa.Integer(), nullable=False, comment='关联的资源ID'),
    sa.Column('resource_type', sa.String(length=50), nullable=False, comment='资源类型, 其值来源于 Resource.resource_type.name'),
    sa.Column('version_tag', sa.String(length=50), nullable=False, comment="版本标签 (e.g., '__workspace__', '1.0.0', 'latest')"),
    sa.Column('name', sa.String(length=255), nullable=False, comment='此版本的名称'),
    sa.Column('description', sa.Text(), nullable=True, comment='此版本的描述'),
    sa.Column('version_notes', sa.Text(), nullable=True, comment='版本更新说明'),
    sa.Column('status', sa.Enum('WORKSPACE', 'DRAFT', 'PUBLISHED', 'ARCHIVED', 'PENDING_APPROVAL', name='versionstatus'), nullable=False, comment='版本状态'),
    sa.Column('visibility', sa.String(length=50), nullable=True, comment='发布时的可见范围, 其值来源于 Resource.resource_type.allowed_visibilities'),
    sa.Column('channel', sa.String(length=50), nullable=True, comment='发布渠道, 其值来源于 Resource.resource_type.allowed_channels'),
    sa.Column('pricing_model', sa.JSON(), nullable=True, comment="定价模型 (e.g., {'type': 'per_call', 'price': 0.001})"),
    sa.Column('api_policy_id', sa.Integer(), nullable=True, comment='本次发布应用的API策略ID'),
    sa.Column('linked_feature_id', sa.Integer(), nullable=True),
    sa.Column('creator_id', sa.Integer(), nullable=False, comment='版本创建者的用户ID'),
    sa.Column('published_by', sa.Integer(), nullable=True, comment='执行发布操作的用户ID'),
    sa.Column('approver_id', sa.Integer(), nullable=True, comment='审核通过的用户ID'),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('now()'), nullable=False, comment='版本创建时间'),
    sa.Column('published_at', sa.DateTime(), nullable=True, comment='版本发布生效时间'),
    sa.ForeignKeyConstraint(['api_policy_id'], ['ai_api_policies.id'], name=op.f('fk_ai_resource_instances_api_policy_id_ai_api_policies')),
    sa.ForeignKeyConstraint(['approver_id'], ['users.id'], name=op.f('fk_ai_resource_instances_approver_id_users')),
    sa.ForeignKeyConstraint(['creator_id'], ['users.id'], name=op.f('fk_ai_resource_instances_creator_id_users')),
    sa.ForeignKeyConstraint(['linked_feature_id'], ['features.id'], name=op.f('fk_ai_resource_instances_linked_feature_id_features')),
    sa.ForeignKeyConstraint(['parent_version_id'], ['ai_resource_instances.id'], name=op.f('fk_ai_resource_instances_parent_version_id_ai_resource_instances'), ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['published_by'], ['users.id'], name=op.f('fk_ai_resource_instances_published_by_users')),
    sa.ForeignKeyConstraint(['resource_id'], ['ai_resources.id'], name=op.f('fk_ai_resource_instances_resource_id_ai_resources'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_ai_resource_instances')),
    sa.UniqueConstraint('resource_id', 'version_tag', name='uq_resource_version_tag')
    )
    op.create_index(op.f('ix_ai_resource_instances_linked_feature_id'), 'ai_resource_instances', ['linked_feature_id'], unique=False)
    op.create_index(op.f('ix_ai_resource_instances_parent_version_id'), 'ai_resource_instances', ['parent_version_id'], unique=False)
    op.create_index(op.f('ix_ai_resource_instances_resource_id'), 'ai_resource_instances', ['resource_id'], unique=False)
    op.create_index(op.f('ix_ai_resource_instances_status'), 'ai_resource_instances', ['status'], unique=False)
    op.create_index(op.f('ix_ai_resource_instances_uuid'), 'ai_resource_instances', ['uuid'], unique=True)
    op.create_index(op.f('ix_ai_resource_instances_version_tag'), 'ai_resource_instances', ['version_tag'], unique=False)
    op.create_index('ix_resource_instances_resource_created_at', 'ai_resource_instances', ['resource_id', 'created_at'], unique=False)
    op.create_index('ix_resource_workspace_status', 'ai_resource_instances', ['resource_id'], unique=True, postgresql_where=sa.text("status = 'WORKSPACE'"))
    op.create_table('assets',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('uuid', sa.String(length=36), nullable=False),
    sa.Column('workspace_id', sa.Integer(), nullable=False),
    sa.Column('folder_id', sa.Integer(), nullable=True),
    sa.Column('creator_id', sa.Integer(), nullable=True),
    sa.Column('storage_provider', sa.String(length=50), nullable=False),
    sa.Column('real_name', sa.String(length=1024), nullable=False, comment='存储桶中的完整物理Key'),
    sa.Column('url', sa.String(length=2048), nullable=False, comment='访问URL'),
    sa.Column('name', sa.String(length=255), nullable=False),
    sa.Column('size', sa.BigInteger(), nullable=False),
    sa.Column('mime_type', sa.String(length=100), nullable=False),
    sa.Column('type', sa.Enum('IMAGE', 'VIDEO', 'AUDIO', 'DOCUMENT', 'OTHER', name='assettype'), nullable=False),
    sa.Column('content_hash', sa.String(length=128), nullable=True),
    sa.Column('status', sa.Enum('PENDING', 'ACTIVE', 'ARCHIVED', name='assetstatus'), nullable=True),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(), server_default=sa.text('now()'), nullable=False),
    sa.Column('is_deleted', sa.Boolean(), nullable=False),
    sa.Column('deleted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['content_hash'], ['assets_intelligence.content_hash'], name=op.f('fk_assets_content_hash_assets_intelligence')),
    sa.ForeignKeyConstraint(['creator_id'], ['users.id'], name=op.f('fk_assets_creator_id_users')),
    sa.ForeignKeyConstraint(['folder_id'], ['assets_folders.id'], name=op.f('fk_assets_folder_id_assets_folders'), ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['workspace_id'], ['ai_workspaces.id'], name=op.f('fk_assets_workspace_id_ai_workspaces'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_assets'))
    )
    op.create_index(op.f('ix_assets_content_hash'), 'assets', ['content_hash'], unique=False)
    op.create_index(op.f('ix_assets_folder_id'), 'assets', ['folder_id'], unique=False)
    op.create_index(op.f('ix_assets_is_deleted'), 'assets', ['is_deleted'], unique=False)
    op.create_index(op.f('ix_assets_status'), 'assets', ['status'], unique=False)
    op.create_index(op.f('ix_assets_type'), 'assets', ['type'], unique=False)
    op.create_index(op.f('ix_assets_uuid'), 'assets', ['uuid'], unique=True)
    op.create_index(op.f('ix_assets_workspace_id'), 'assets', ['workspace_id'], unique=False)
    op.create_table('invitations',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('uuid', sa.String(length=36), nullable=False),
    sa.Column('credential_type', sa.Enum('INVITATION_LINK', 'MAGIC_LINK', 'ACCESS_CODE', name='credentialtype'), nullable=False, comment='凭证的类型'),
    sa.Column('token', sa.String(length=128), nullable=False, comment='凭证的唯一令牌 (链接、代码等)'),
    sa.Column('target_identifier_type', sa.Enum('EMAIL', 'PHONE', 'USER_ID', name='targetidentifiertype'), nullable=True, comment='目标身份标识的类型'),
    sa.Column('target_identifier', sa.String(length=255), nullable=True, comment='目标身份标识 (邮箱、手机号或平台用户ID)'),
    sa.Column('target_entity_type', sa.String(length=50), nullable=False, comment="被邀请加入的实体类型 (e.g., 'team')"),
    sa.Column('target_entity_id', sa.Integer(), nullable=False, comment='被邀请加入的实体ID'),
    sa.Column('inviter_id', sa.Integer(), nullable=False),
    sa.Column('role_id', sa.Integer(), nullable=False),
    sa.Column('status', sa.Enum('PENDING', 'ACCEPTED', 'EXPIRED', 'CANCELED', name='invitationstatus'), nullable=False),
    sa.Column('expires_at', sa.DateTime(), nullable=False, comment='凭证过期时间'),
    sa.Column('accepted_by_user_id', sa.Integer(), nullable=True),
    sa.Column('created_member_id', sa.Integer(), nullable=True),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('now()'), nullable=False),
    sa.Column('accepted_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['accepted_by_user_id'], ['users.id'], name=op.f('fk_invitations_accepted_by_user_id_users')),
    sa.ForeignKeyConstraint(['inviter_id'], ['users.id'], name=op.f('fk_invitations_inviter_id_users'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['role_id'], ['roles.id'], name=op.f('fk_invitations_role_id_roles')),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_invitations'))
    )
    op.create_index(op.f('ix_invitations_target_entity_id'), 'invitations', ['target_entity_id'], unique=False)
    op.create_index(op.f('ix_invitations_target_identifier'), 'invitations', ['target_identifier'], unique=False)
    op.create_index(op.f('ix_invitations_token'), 'invitations', ['token'], unique=True)
    op.create_index(op.f('ix_invitations_uuid'), 'invitations', ['uuid'], unique=True)
    op.create_table('products',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=255), nullable=False, comment="产品的唯一标识符 (e.g., 'plan:pro', 'feature:llm:tokens:input:openai:gpt-4o-2024-05-13')"),
    sa.Column('label', sa.String(length=255), nullable=False, comment="UI上显示的产品名称 (e.g., 'Pro版订阅 (月付)', 'gpt-4o-2024-05-13 输入Token用量')"),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('type', sa.Enum('MEMBERSHIP', 'ADD_ON', 'ONE_TIME', 'USAGE', name='producttype'), nullable=False, comment='产品类型'),
    sa.Column('plan_tier', sa.Enum('FREE', 'PRO', 'TEAM', 'ENTERPRISE', name='plantier'), nullable=True, comment='如果产品是会员资格型，此字段记录其对应的会员等级'),
    sa.Column('granted_role_id', sa.Integer(), nullable=True, comment='该产品授予用户的系统角色ID'),
    sa.Column('feature_id', sa.Integer(), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=False, comment='该产品当前是否可售卖'),
    sa.Column('is_purchasable', sa.Boolean(), nullable=False, comment='该产品当前是否可公开购买'),
    sa.CheckConstraint("type != 'MEMBERSHIP' OR plan_tier IS NOT NULL", name=op.f('ck_products_ck_product_membership_requires_plan_tier')),
    sa.CheckConstraint("type = 'USAGE' AND feature_id IS NOT NULL OR type IN ('MEMBERSHIP', 'ADD_ON', 'ONE_TIME') AND feature_id IS NULL", name=op.f('ck_products_ck_product_feature_link_by_type')),
    sa.ForeignKeyConstraint(['feature_id'], ['features.id'], name=op.f('fk_products_feature_id_features')),
    sa.ForeignKeyConstraint(['granted_role_id'], ['roles.id'], name=op.f('fk_products_granted_role_id_roles')),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_products')),
    sa.UniqueConstraint('feature_id', name=op.f('uq_products_feature_id')),
    sa.UniqueConstraint('name', name=op.f('uq_products_name'))
    )
    op.create_table('role_permissions',
    sa.Column('role_id', sa.Integer(), nullable=False, comment='角色ID'),
    sa.Column('permission_id', sa.Integer(), nullable=False, comment='权限ID'),
    sa.ForeignKeyConstraint(['permission_id'], ['action_permissions.id'], name=op.f('fk_role_permissions_permission_id_action_permissions'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['role_id'], ['roles.id'], name=op.f('fk_role_permissions_role_id_roles'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('role_id', 'permission_id', name=op.f('pk_role_permissions'))
    )
    op.create_table('ai_agent_context_summaries',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('uuid', sa.String(length=36), nullable=True),
    sa.Column('agent_instance_id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('scope', sa.Enum('USER', 'SESSION', name='summaryscope'), nullable=False),
    sa.Column('session_uuid', sa.String(length=36), nullable=True, comment='如果是 Session 级，必须绑定 Session UUID'),
    sa.Column('trace_id', sa.String(length=36), nullable=False, comment='该摘要对应的原始对话轮次Trace ID'),
    sa.Column('module_version_id', sa.Integer(), nullable=True),
    sa.Column('content', sa.Text(), nullable=False, comment='LLM生成的摘要内容'),
    sa.Column('is_archived', sa.Boolean(), nullable=True, comment='是否已归档（不再被检索到，但保留记录）'),
    sa.Column('ref_created_at', sa.DateTime(), nullable=True, comment='原始对话轮次的发生时间'),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('now()'), nullable=True),
    sa.Column('updated_at', sa.DateTime(), server_default=sa.text('now()'), nullable=True),
    sa.ForeignKeyConstraint(['agent_instance_id'], ['ai_resource_instances.id'], name=op.f('fk_ai_agent_context_summaries_agent_instance_id_ai_resource_instances'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['module_version_id'], ['service_module_versions.id'], name=op.f('fk_ai_agent_context_summaries_module_version_id_service_module_versions'), ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name=op.f('fk_ai_agent_context_summaries_user_id_users'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_ai_agent_context_summaries'))
    )
    op.create_index(op.f('ix_ai_agent_context_summaries_agent_instance_id'), 'ai_agent_context_summaries', ['agent_instance_id'], unique=False)
    op.create_index(op.f('ix_ai_agent_context_summaries_is_archived'), 'ai_agent_context_summaries', ['is_archived'], unique=False)
    op.create_index(op.f('ix_ai_agent_context_summaries_ref_created_at'), 'ai_agent_context_summaries', ['ref_created_at'], unique=False)
    op.create_index(op.f('ix_ai_agent_context_summaries_scope'), 'ai_agent_context_summaries', ['scope'], unique=False)
    op.create_index(op.f('ix_ai_agent_context_summaries_session_uuid'), 'ai_agent_context_summaries', ['session_uuid'], unique=False)
    op.create_index(op.f('ix_ai_agent_context_summaries_trace_id'), 'ai_agent_context_summaries', ['trace_id'], unique=False)
    op.create_index(op.f('ix_ai_agent_context_summaries_user_id'), 'ai_agent_context_summaries', ['user_id'], unique=False)
    op.create_index(op.f('ix_ai_agent_context_summaries_uuid'), 'ai_agent_context_summaries', ['uuid'], unique=True)
    op.create_table('ai_agents',
    sa.Column('version_id', sa.Integer(), nullable=False),
    sa.Column('agent_config', sa.JSON(), nullable=False, comment='AgentConfig (temperature, top_p, etc.)'),
    sa.Column('system_prompt', sa.Text(), nullable=True, comment='System level instruction'),
    sa.Column('llm_module_version_id', sa.Integer(), nullable=False),
    sa.ForeignKeyConstraint(['llm_module_version_id'], ['service_module_versions.id'], name=op.f('fk_ai_agents_llm_module_version_id_service_module_versions')),
    sa.ForeignKeyConstraint(['version_id'], ['ai_resource_instances.id'], name=op.f('fk_ai_agents_version_id_ai_resource_instances'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('version_id', name=op.f('pk_ai_agents'))
    )
    op.create_table('ai_chat_sessions',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('uuid', sa.String(length=36), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('agent_instance_id', sa.Integer(), nullable=False),
    sa.Column('title', sa.String(length=255), nullable=True, comment='会话标题 (自动生成或用户设定)'),
    sa.Column('summary', sa.Text(), nullable=True, comment='会话摘要'),
    sa.Column('message_count', sa.Integer(), nullable=False, comment='正常消息数量'),
    sa.Column('is_archived', sa.Boolean(), nullable=True, comment='会话是否已归档(软删除)'),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.DateTime(), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['agent_instance_id'], ['ai_resource_instances.id'], name=op.f('fk_ai_chat_sessions_agent_instance_id_ai_resource_instances')),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name=op.f('fk_ai_chat_sessions_user_id_users'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_ai_chat_sessions'))
    )
    op.create_index(op.f('ix_ai_chat_sessions_agent_instance_id'), 'ai_chat_sessions', ['agent_instance_id'], unique=False)
    op.create_index(op.f('ix_ai_chat_sessions_is_archived'), 'ai_chat_sessions', ['is_archived'], unique=False)
    op.create_index(op.f('ix_ai_chat_sessions_user_id'), 'ai_chat_sessions', ['user_id'], unique=False)
    op.create_index(op.f('ix_ai_chat_sessions_uuid'), 'ai_chat_sessions', ['uuid'], unique=True)
    op.create_table('ai_knowledge_bases',
    sa.Column('version_id', sa.Integer(), nullable=False),
    sa.Column('collection_name', sa.String(length=255), nullable=False, comment='The unique collection name in the physical vector store'),
    sa.Column('engine_alias', sa.String(length=50), nullable=False, comment="The alias of the physical vector engine to use (e.g., 'default', 'high_perf')"),
    sa.Column('embedding_module_version_id', sa.Integer(), nullable=False),
    sa.Column('config', sa.JSON(), nullable=True, comment='The declarative configuration for the data processing pipeline.'),
    sa.ForeignKeyConstraint(['embedding_module_version_id'], ['service_module_versions.id'], name=op.f('fk_ai_knowledge_bases_embedding_module_version_id_service_module_versions')),
    sa.ForeignKeyConstraint(['version_id'], ['ai_resource_instances.id'], name=op.f('fk_ai_knowledge_bases_version_id_ai_resource_instances'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('version_id', name=op.f('pk_ai_knowledge_bases'))
    )
    op.create_index(op.f('ix_ai_knowledge_bases_collection_name'), 'ai_knowledge_bases', ['collection_name'], unique=False)
    op.create_index(op.f('ix_ai_knowledge_bases_engine_alias'), 'ai_knowledge_bases', ['engine_alias'], unique=False)
    op.create_table('ai_resource_refs',
    sa.Column('id', sa.Integer(), nullable=False, comment='引用关系唯一主键ID'),
    sa.Column('source_resource_id', sa.Integer(), nullable=False, comment='发起引用的源逻辑资源ID'),
    sa.Column('source_instance_id', sa.Integer(), nullable=False, comment='发起引用的源资源具体版本ID'),
    sa.Column('source_node_uuid', sa.String(length=64), nullable=False, comment='源资源内部的局部节点/组件标识符'),
    sa.Column('target_resource_id', sa.Integer(), nullable=False, comment='被引用的目标逻辑资源ID'),
    sa.Column('target_instance_id', sa.Integer(), nullable=False, comment='被引用的目标资源具体版本ID (版本锁定)'),
    sa.Column('alias', sa.String(length=255), nullable=True, comment="别名，用于代码中引用 (e.g. 'weather_tool')"),
    sa.Column('options', sa.JSON(), nullable=True, comment='引用携带的配置'),
    sa.ForeignKeyConstraint(['source_instance_id'], ['ai_resource_instances.id'], name=op.f('fk_ai_resource_refs_source_instance_id_ai_resource_instances'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['source_resource_id'], ['ai_resources.id'], name=op.f('fk_ai_resource_refs_source_resource_id_ai_resources'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['target_instance_id'], ['ai_resource_instances.id'], name=op.f('fk_ai_resource_refs_target_instance_id_ai_resource_instances'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['target_resource_id'], ['ai_resources.id'], name=op.f('fk_ai_resource_refs_target_resource_id_ai_resources'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_ai_resource_refs')),
    sa.UniqueConstraint('source_instance_id', 'source_node_uuid', 'target_instance_id', name='uq_ref_edge')
    )
    op.create_index(op.f('ix_ai_resource_refs_source_instance_id'), 'ai_resource_refs', ['source_instance_id'], unique=False)
    op.create_index(op.f('ix_ai_resource_refs_source_node_uuid'), 'ai_resource_refs', ['source_node_uuid'], unique=False)
    op.create_index(op.f('ix_ai_resource_refs_source_resource_id'), 'ai_resource_refs', ['source_resource_id'], unique=False)
    op.create_index(op.f('ix_ai_resource_refs_target_instance_id'), 'ai_resource_refs', ['target_instance_id'], unique=False)
    op.create_index(op.f('ix_ai_resource_refs_target_resource_id'), 'ai_resource_refs', ['target_resource_id'], unique=False)
    op.create_table('ai_tenant_dbs',
    sa.Column('version_id', sa.Integer(), nullable=False),
    sa.Column('schema_name', sa.String(length=63), nullable=False, comment='在租户数据平面DB中对应的Schema名称'),
    sa.ForeignKeyConstraint(['version_id'], ['ai_resource_instances.id'], name=op.f('fk_ai_tenant_dbs_version_id_ai_resource_instances'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('version_id', name=op.f('pk_ai_tenant_dbs'))
    )
    op.create_index(op.f('ix_ai_tenant_dbs_schema_name'), 'ai_tenant_dbs', ['schema_name'], unique=False)
    op.create_table('ai_tools',
    sa.Column('version_id', sa.Integer(), nullable=False),
    sa.Column('url', sa.String(length=2048), nullable=True, comment='工具的API端点URL'),
    sa.Column('method', sa.String(length=10), nullable=False, comment='HTTP请求方法 (GET, POST, etc.)'),
    sa.Column('inputs_schema', sa.JSON(), nullable=False, comment='输入参数的JSON Schema'),
    sa.Column('outputs_schema', sa.JSON(), nullable=False, comment='输出结果的JSON Schema'),
    sa.Column('llm_function_schema', sa.JSON(), nullable=True, comment='提供给大语言模型的Function Calling Schema'),
    sa.ForeignKeyConstraint(['version_id'], ['ai_resource_instances.id'], name=op.f('fk_ai_tools_version_id_ai_resource_instances'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('version_id', name=op.f('pk_ai_tools'))
    )
    op.create_table('ai_uiapps',
    sa.Column('version_id', sa.Integer(), nullable=False),
    sa.Column('global_config', sa.JSON(), nullable=False, comment='全局配置'),
    sa.Column('navigation', sa.JSON(), nullable=True, comment='导航菜单定义'),
    sa.Column('home_page_uuid', sa.String(length=64), nullable=True, comment='默认首页的Page UUID'),
    sa.ForeignKeyConstraint(['version_id'], ['ai_resource_instances.id'], name=op.f('fk_ai_uiapps_version_id_ai_resource_instances'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('version_id', name=op.f('pk_ai_uiapps'))
    )
    op.create_table('ai_workflows',
    sa.Column('version_id', sa.Integer(), nullable=False),
    sa.Column('graph', sa.JSON(), nullable=False, comment='工作流的DSL图结构'),
    sa.Column('inputs_schema', sa.JSON(), nullable=False, comment='工作流输入参数定义 (List[ParameterSchema])'),
    sa.Column('outputs_schema', sa.JSON(), nullable=False, comment='工作流输出结构定义 (List[ParameterSchema])'),
    sa.Column('is_stream', sa.Boolean(), nullable=False, comment='是否支持流式输出'),
    sa.ForeignKeyConstraint(['version_id'], ['ai_resource_instances.id'], name=op.f('fk_ai_workflows_version_id_ai_resource_instances'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('version_id', name=op.f('pk_ai_workflows'))
    )
    op.create_table('membership_history',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('product_id', sa.Integer(), nullable=False),
    sa.Column('plan_tier', sa.Enum('FREE', 'PRO', 'TEAM', 'ENTERPRISE', name='plantier'), nullable=False),
    sa.Column('role_id', sa.Integer(), nullable=False),
    sa.Column('status', sa.Enum('ACTIVE', 'EXPIRED', 'CANCELED', 'TRIALING', name='membershipstatus'), nullable=False),
    sa.Column('billing_cycle', sa.Enum('DAY', 'WEEK', 'MONTH', 'QUARTER', 'YEAR', name='billingcycle'), nullable=False),
    sa.Column('period_start', sa.DateTime(), nullable=False),
    sa.Column('period_end', sa.DateTime(), nullable=True),
    sa.Column('change_type', sa.Enum('GRANT', 'RENEW', 'UPGRADE', 'DOWNGRADE', 'CANCEL', 'EXPIRE', name='membershipchangetype'), nullable=False),
    sa.Column('change_timestamp', sa.DateTime(), server_default=sa.text('now()'), nullable=False),
    sa.Column('notes', sa.Text(), nullable=True),
    sa.ForeignKeyConstraint(['product_id'], ['products.id'], name=op.f('fk_membership_history_product_id_products')),
    sa.ForeignKeyConstraint(['role_id'], ['roles.id'], name=op.f('fk_membership_history_role_id_roles')),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name=op.f('fk_membership_history_user_id_users'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_membership_history'))
    )
    op.create_index(op.f('ix_membership_history_user_id'), 'membership_history', ['user_id'], unique=False)
    op.create_table('memberships',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('uuid', sa.String(length=36), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('product_id', sa.Integer(), nullable=False),
    sa.Column('plan_tier', sa.Enum('FREE', 'PRO', 'TEAM', 'ENTERPRISE', name='plantier'), nullable=False, comment='[权威账户级别事实] 从 Product 表的`name`冗余而来(产品类型必须是membership'),
    sa.Column('role_id', sa.Integer(), nullable=False, comment='[权威角色事实] 从 Product 表的`granted_role_id`冗余而来'),
    sa.Column('status', sa.Enum('ACTIVE', 'EXPIRED', 'CANCELED', 'TRIALING', name='membershipstatus'), nullable=False),
    sa.Column('billing_cycle', sa.Enum('DAY', 'WEEK', 'MONTH', 'QUARTER', 'YEAR', name='billingcycle'), nullable=False, comment='购买时从 Price 表快照而来的计费周期。'),
    sa.Column('current_period_start', sa.DateTime(), nullable=False),
    sa.Column('current_period_end', sa.DateTime(), nullable=True, comment='周期结束时间。NULL 表示永久有效。'),
    sa.Column('gateway_subscription_id', sa.String(length=255), nullable=True),
    sa.Column('updated_at', sa.DateTime(), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['product_id'], ['products.id'], name=op.f('fk_memberships_product_id_products')),
    sa.ForeignKeyConstraint(['role_id'], ['roles.id'], name=op.f('fk_memberships_role_id_roles')),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name=op.f('fk_memberships_user_id_users'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_memberships')),
    sa.UniqueConstraint('gateway_subscription_id', name=op.f('uq_memberships_gateway_subscription_id'))
    )
    op.create_index(op.f('ix_memberships_status'), 'memberships', ['status'], unique=False)
    op.create_index(op.f('ix_memberships_user_id'), 'memberships', ['user_id'], unique=True)
    op.create_index(op.f('ix_memberships_uuid'), 'memberships', ['uuid'], unique=True)
    op.create_table('prices',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('product_id', sa.Integer(), nullable=True),
    sa.Column('amount', sa.DECIMAL(precision=18, scale=8), nullable=False, comment='价格'),
    sa.Column('currency', sa.Enum('CNY', 'USD', 'EUR', 'JPY', 'GBP', name='currency'), nullable=False, comment="货币单位 (e.g., 'usd', 'cny')"),
    sa.Column('billing_cycle', sa.Enum('DAY', 'WEEK', 'MONTH', 'QUARTER', 'YEAR', name='billingcycle'), nullable=True, comment='对于订阅，计费周期。NULL表示为一次性购买。'),
    sa.Column('unit', sa.String(length=50), nullable=True),
    sa.Column('unit_count', sa.Integer(), nullable=False),
    sa.Column('is_active', sa.Boolean(), nullable=False, comment='该价格当前是否有效'),
    sa.ForeignKeyConstraint(['product_id'], ['products.id'], name=op.f('fk_prices_product_id_products'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_prices'))
    )
    op.create_table('product_entitlements',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('product_id', sa.Integer(), nullable=False),
    sa.Column('feature_id', sa.Integer(), nullable=False),
    sa.Column('quota', sa.Integer(), nullable=False, comment='包含的免费额度 (e.g., 1,000,000 for tokens, 10 for GB)'),
    sa.Column('validity_period_days', sa.Integer(), nullable=True, comment='权益的有效期（天）。NULL表示与订阅周期同步或永不过期。'),
    sa.Column('is_resettable', sa.Boolean(), nullable=False, comment='该权益是否在每个计费周期重置。'),
    sa.Column('is_active', sa.Boolean(), nullable=False, comment='该权益模板当前是否可用'),
    sa.ForeignKeyConstraint(['feature_id'], ['features.id'], name=op.f('fk_product_entitlements_feature_id_features'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['product_id'], ['products.id'], name=op.f('fk_product_entitlements_product_id_products'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_product_entitlements')),
    sa.UniqueConstraint('product_id', 'feature_id', name='uq_product_feature_entitlement')
    )
    op.create_index(op.f('ix_product_entitlements_feature_id'), 'product_entitlements', ['feature_id'], unique=False)
    op.create_index(op.f('ix_product_entitlements_product_id'), 'product_entitlements', ['product_id'], unique=False)
    op.create_table('team_members',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('uuid', sa.String(length=36), nullable=False, comment='团队成员的全局唯一标识符'),
    sa.Column('team_id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('role_id', sa.Integer(), nullable=False, comment='成员在该团队的角色ID'),
    sa.Column('origin_invitation_id', sa.Integer(), nullable=True, comment='创建此成员关系的邀请ID，用于溯源'),
    sa.Column('joined_at', sa.DateTime(), server_default=sa.text('now()'), nullable=False, comment='成员加入时间'),
    sa.ForeignKeyConstraint(['origin_invitation_id'], ['invitations.id'], name=op.f('fk_team_members_origin_invitation_id_invitations'), ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['role_id'], ['roles.id'], name=op.f('fk_team_members_role_id_roles')),
    sa.ForeignKeyConstraint(['team_id'], ['teams.id'], name=op.f('fk_team_members_team_id_teams'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name=op.f('fk_team_members_user_id_users'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_team_members')),
    sa.UniqueConstraint('origin_invitation_id', name=op.f('uq_team_members_origin_invitation_id')),
    sa.UniqueConstraint('team_id', 'user_id', name='uq_team_user')
    )
    op.create_index(op.f('ix_team_members_uuid'), 'team_members', ['uuid'], unique=True)
    op.create_table('traces',
    sa.Column('id', sa.Integer(), nullable=False, comment='物理自增主键，用于聚集索引和分页'),
    sa.Column('span_uuid', sa.String(length=36), nullable=False, comment='Span的逻辑唯一ID (UUID)'),
    sa.Column('trace_id', sa.String(length=36), nullable=False, comment='全链路追踪ID，贯穿整个请求周期'),
    sa.Column('parent_span_uuid', sa.String(length=36), nullable=True, comment='父Span的逻辑UUID'),
    sa.Column('user_id', sa.Integer(), nullable=False, comment='发起调用的终端用户ID'),
    sa.Column('api_key_id', sa.Integer(), nullable=True, comment='[可选]用于本次调用的API密钥ID'),
    sa.Column('source_instance_id', sa.Integer(), nullable=True),
    sa.Column('target_instance_id', sa.Integer(), nullable=True),
    sa.Column('operation_name', sa.String(length=255), nullable=False, comment="操作的名称，用于分类和聚合 (e.g., 'user.input', 'llm.completion', 'tool.call', 'workflow.call)"),
    sa.Column('context_type', sa.String(length=50), nullable=True, comment='业务容器类型'),
    sa.Column('context_id', sa.String(length=36), nullable=True, comment='业务容器ID'),
    sa.Column('attributes', sa.JSON(), nullable=True, comment='结构化的调试数据快照 (Inputs, Outputs, Meta)'),
    sa.Column('status', sa.Enum('PENDING', 'PROCESSED', 'FAILED', 'CANCELLED', name='tracestatus'), nullable=False),
    sa.Column('duration_ms', sa.Integer(), nullable=True, comment='调用持续时间(毫秒)'),
    sa.Column('error_message', sa.Text(), nullable=True, comment='如果发生错误，记录错误信息'),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('now()'), nullable=False, comment='操作开始的时间戳'),
    sa.Column('processed_at', sa.DateTime(), nullable=True, comment='操作完成的时间戳'),
    sa.ForeignKeyConstraint(['api_key_id'], ['api_keys.id'], name=op.f('fk_traces_api_key_id_api_keys')),
    sa.ForeignKeyConstraint(['parent_span_uuid'], ['traces.span_uuid'], name=op.f('fk_traces_parent_span_uuid_traces'), use_alter=True),
    sa.ForeignKeyConstraint(['source_instance_id'], ['ai_resource_instances.id'], name=op.f('fk_traces_source_instance_id_ai_resource_instances')),
    sa.ForeignKeyConstraint(['target_instance_id'], ['ai_resource_instances.id'], name=op.f('fk_traces_target_instance_id_ai_resource_instances')),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name=op.f('fk_traces_user_id_users')),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_traces'))
    )
    op.create_index(op.f('ix_traces_api_key_id'), 'traces', ['api_key_id'], unique=False)
    op.create_index(op.f('ix_traces_context_id'), 'traces', ['context_id'], unique=False)
    op.create_index(op.f('ix_traces_context_type'), 'traces', ['context_type'], unique=False)
    op.create_index(op.f('ix_traces_created_at'), 'traces', ['created_at'], unique=False)
    op.create_index(op.f('ix_traces_operation_name'), 'traces', ['operation_name'], unique=False)
    op.create_index(op.f('ix_traces_parent_span_uuid'), 'traces', ['parent_span_uuid'], unique=False)
    op.create_index(op.f('ix_traces_processed_at'), 'traces', ['processed_at'], unique=False)
    op.create_index(op.f('ix_traces_source_instance_id'), 'traces', ['source_instance_id'], unique=False)
    op.create_index(op.f('ix_traces_span_uuid'), 'traces', ['span_uuid'], unique=True)
    op.create_index(op.f('ix_traces_status'), 'traces', ['status'], unique=False)
    op.create_index(op.f('ix_traces_target_instance_id'), 'traces', ['target_instance_id'], unique=False)
    op.create_index(op.f('ix_traces_trace_id'), 'traces', ['trace_id'], unique=False)
    op.create_index(op.f('ix_traces_user_id'), 'traces', ['user_id'], unique=False)
    op.create_table('ai_agent_memories',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('agent_id', sa.Integer(), nullable=False),
    sa.Column('key', sa.String(length=64), nullable=False, comment='变量名 (英文标识符)'),
    sa.Column('label', sa.String(length=64), nullable=False, comment='显示名称'),
    sa.Column('type', sa.Enum('STRING', 'NUMBER', 'BOOLEAN', 'LIST', 'OBJECT', name='memorytype'), nullable=False, comment='变量类型'),
    sa.Column('description', sa.Text(), nullable=True, comment='语义描述，帮助 LLM 理解该变量的用途'),
    sa.Column('default_value', sa.Text(), nullable=True, comment='默认值 (序列化后的字符串)'),
    sa.Column('scope_type', sa.Enum('USER', 'SESSION', name='memoryscope'), nullable=False, comment='记忆的作用范围'),
    sa.Column('is_active', sa.Boolean(), nullable=True, comment='是否启用'),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('now()'), nullable=True),
    sa.Column('updated_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['agent_id'], ['ai_agents.version_id'], name=op.f('fk_ai_agent_memories_agent_id_ai_agents'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_ai_agent_memories')),
    sa.UniqueConstraint('agent_id', 'key', name='uq_agent_memory_key')
    )
    op.create_index(op.f('ix_ai_agent_memories_agent_id'), 'ai_agent_memories', ['agent_id'], unique=False)
    op.create_table('ai_chat_messages',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('uuid', sa.String(length=36), nullable=False),
    sa.Column('session_id', sa.Integer(), nullable=False),
    sa.Column('role', sa.Enum('SYSTEM', 'USER', 'ASSISTANT', 'TOOL', name='messagerole'), nullable=False),
    sa.Column('content', sa.Text(), nullable=True),
    sa.Column('meta', sa.JSON(), nullable=True),
    sa.Column('tool_calls', sa.JSON(), nullable=True),
    sa.Column('tool_call_id', sa.String(length=100), nullable=True),
    sa.Column('token_count', sa.Integer(), nullable=True, comment='估算的 Token 数量'),
    sa.Column('trace_id', sa.String(length=36), nullable=True, comment='关联的 Trace ID'),
    sa.Column('is_deleted', sa.Boolean(), nullable=True),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['session_id'], ['ai_chat_sessions.id'], name=op.f('fk_ai_chat_messages_session_id_ai_chat_sessions'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_ai_chat_messages'))
    )
    op.create_index(op.f('ix_ai_chat_messages_is_deleted'), 'ai_chat_messages', ['is_deleted'], unique=False)
    op.create_index(op.f('ix_ai_chat_messages_session_id'), 'ai_chat_messages', ['session_id'], unique=False)
    op.create_index(op.f('ix_ai_chat_messages_trace_id'), 'ai_chat_messages', ['trace_id'], unique=False)
    op.create_index(op.f('ix_ai_chat_messages_uuid'), 'ai_chat_messages', ['uuid'], unique=True)
    op.create_table('ai_tenant_tables',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('uuid', sa.String(length=36), nullable=False),
    sa.Column('tenantdb_id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=63), nullable=False, comment='表名，必须符合PostgreSQL标识符规范'),
    sa.Column('label', sa.String(length=255), nullable=True, comment='在UI中展示的友好名称'),
    sa.Column('description', sa.Text(), nullable=True),
    sa.ForeignKeyConstraint(['tenantdb_id'], ['ai_tenant_dbs.version_id'], name=op.f('fk_ai_tenant_tables_tenantdb_id_ai_tenant_dbs'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_ai_tenant_tables')),
    sa.UniqueConstraint('tenantdb_id', 'name', name='uq_tenantdb_table_name')
    )
    op.create_index(op.f('ix_ai_tenant_tables_tenantdb_id'), 'ai_tenant_tables', ['tenantdb_id'], unique=False)
    op.create_index(op.f('ix_ai_tenant_tables_uuid'), 'ai_tenant_tables', ['uuid'], unique=True)
    op.create_table('ai_uiapp_pages',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('app_version_id', sa.Integer(), nullable=False),
    sa.Column('page_uuid', sa.String(length=64), nullable=False),
    sa.Column('path', sa.String(length=255), nullable=False, comment='路由路径, e.g. /dashboard'),
    sa.Column('label', sa.String(length=255), nullable=False, comment='页面标题'),
    sa.Column('icon', sa.String(length=100), nullable=True),
    sa.Column('display_order', sa.Integer(), nullable=True),
    sa.Column('data', sa.JSON(), nullable=False, comment='组件树 DSL'),
    sa.Column('config', sa.JSON(), nullable=True),
    sa.ForeignKeyConstraint(['app_version_id'], ['ai_uiapps.version_id'], name=op.f('fk_ai_uiapp_pages_app_version_id_ai_uiapps'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_ai_uiapp_pages')),
    sa.UniqueConstraint('app_version_id', 'page_uuid', name='uq_uiapp_version_page'),
    sa.UniqueConstraint('app_version_id', 'path', name='uq_uiapp_version_path')
    )
    op.create_index(op.f('ix_ai_uiapp_pages_app_version_id'), 'ai_uiapp_pages', ['app_version_id'], unique=False)
    op.create_table('consumption_records',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('billing_account_id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=False),
    sa.Column('feature_id', sa.Integer(), nullable=False, comment='[价值归因] 本次消耗对应的计费单元ID'),
    sa.Column('usage', sa.DECIMAL(precision=16, scale=4), nullable=False),
    sa.Column('cost', sa.DECIMAL(precision=18, scale=8), nullable=False),
    sa.Column('status', sa.Enum('PENDING', 'COMPLETED', 'FAILED', name='consumptionrecordstatus'), nullable=False),
    sa.Column('error_message', sa.Text(), nullable=True),
    sa.Column('reservation_snapshot', sa.JSON(), nullable=True),
    sa.Column('trace_span_id', sa.Integer(), nullable=True),
    sa.Column('created_at', sa.DateTime(), server_default=sa.text('now()'), nullable=False),
    sa.Column('completed_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['billing_account_id'], ['billing_accounts.id'], name=op.f('fk_consumption_records_billing_account_id_billing_accounts')),
    sa.ForeignKeyConstraint(['feature_id'], ['features.id'], name=op.f('fk_consumption_records_feature_id_features')),
    sa.ForeignKeyConstraint(['trace_span_id'], ['traces.id'], name=op.f('fk_consumption_records_trace_span_id_traces')),
    sa.ForeignKeyConstraint(['user_id'], ['users.id'], name=op.f('fk_consumption_records_user_id_users')),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_consumption_records'))
    )
    op.create_index(op.f('ix_consumption_records_billing_account_id'), 'consumption_records', ['billing_account_id'], unique=False)
    op.create_index(op.f('ix_consumption_records_feature_id'), 'consumption_records', ['feature_id'], unique=False)
    op.create_index(op.f('ix_consumption_records_status'), 'consumption_records', ['status'], unique=False)
    op.create_index(op.f('ix_consumption_records_trace_span_id'), 'consumption_records', ['trace_span_id'], unique=True)
    op.create_index(op.f('ix_consumption_records_user_id'), 'consumption_records', ['user_id'], unique=False)
    op.create_table('entitlement_balances',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('owner_user_id', sa.Integer(), nullable=True),
    sa.Column('owner_team_id', sa.Integer(), nullable=True),
    sa.Column('source_entitlement_id', sa.Integer(), nullable=False),
    sa.Column('feature_id', sa.Integer(), nullable=False),
    sa.Column('granted_quota', sa.DECIMAL(precision=16, scale=4), nullable=False),
    sa.Column('consumed_usage', sa.DECIMAL(precision=16, scale=4), nullable=False),
    sa.Column('start_date', sa.DateTime(), nullable=False),
    sa.Column('end_date', sa.DateTime(), nullable=True),
    sa.Column('status', sa.Enum('ACTIVE', 'EXPIRED', 'CANCELLED', 'DEPLETED', name='entitlementbalancestatus'), nullable=False),
    sa.Column('updated_at', sa.DateTime(), server_default=sa.text('now()'), nullable=False),
    sa.CheckConstraint('(owner_user_id IS NOT NULL AND owner_team_id IS NULL) OR (owner_user_id IS NULL AND owner_team_id IS NOT NULL)', name=op.f('ck_entitlement_balances_ck_entitlement_owner_exclusive')),
    sa.ForeignKeyConstraint(['feature_id'], ['features.id'], name=op.f('fk_entitlement_balances_feature_id_features')),
    sa.ForeignKeyConstraint(['owner_team_id'], ['teams.id'], name=op.f('fk_entitlement_balances_owner_team_id_teams'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['owner_user_id'], ['users.id'], name=op.f('fk_entitlement_balances_owner_user_id_users'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['source_entitlement_id'], ['product_entitlements.id'], name=op.f('fk_entitlement_balances_source_entitlement_id_product_entitlements')),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_entitlement_balances'))
    )
    op.create_index(op.f('ix_entitlement_balances_feature_id'), 'entitlement_balances', ['feature_id'], unique=False)
    op.create_index(op.f('ix_entitlement_balances_owner_team_id'), 'entitlement_balances', ['owner_team_id'], unique=False)
    op.create_index(op.f('ix_entitlement_balances_owner_user_id'), 'entitlement_balances', ['owner_user_id'], unique=False)
    op.create_index(op.f('ix_entitlement_balances_status'), 'entitlement_balances', ['status'], unique=False)
    op.create_table('knowledge_base_version_documents',
    sa.Column('version_id', sa.Integer(), nullable=False),
    sa.Column('document_id', sa.Integer(), nullable=False),
    sa.ForeignKeyConstraint(['document_id'], ['ai_knowledge_documents.id'], name=op.f('fk_knowledge_base_version_documents_document_id_ai_knowledge_documents'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['version_id'], ['ai_knowledge_bases.version_id'], name=op.f('fk_knowledge_base_version_documents_version_id_ai_knowledge_bases'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('version_id', 'document_id', name=op.f('pk_knowledge_base_version_documents'))
    )
    op.create_table('price_tiers',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('price_id', sa.Integer(), nullable=False),
    sa.Column('feature_id', sa.Integer(), nullable=False),
    sa.Column('amount', sa.DECIMAL(precision=18, scale=8), nullable=False, comment='价格'),
    sa.Column('up_to', sa.Integer(), nullable=True, comment='阶梯定价的上限 (e.g., 1000000), NULL表示无限'),
    sa.ForeignKeyConstraint(['feature_id'], ['features.id'], name=op.f('fk_price_tiers_feature_id_features'), ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['price_id'], ['prices.id'], name=op.f('fk_price_tiers_price_id_prices'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_price_tiers'))
    )
    op.create_table('ai_agent_memory_values',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('memory_id', sa.Integer(), nullable=False),
    sa.Column('user_id', sa.Integer(), nullable=True),
    sa.Column('session_uuid', sa.String(length=36), nullable=True),
    sa.Column('value', sa.Text(), nullable=True),
    sa.Column('updated_at', sa.DateTime(), server_default=sa.text('now()'), nullable=True),
    sa.ForeignKeyConstraint(['memory_id'], ['ai_agent_memories.id'], name=op.f('fk_ai_agent_memory_values_memory_id_ai_agent_memories'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_ai_agent_memory_values'))
    )
    op.create_index(op.f('ix_ai_agent_memory_values_memory_id'), 'ai_agent_memory_values', ['memory_id'], unique=False)
    op.create_index(op.f('ix_ai_agent_memory_values_session_uuid'), 'ai_agent_memory_values', ['session_uuid'], unique=False)
    op.create_index(op.f('ix_ai_agent_memory_values_user_id'), 'ai_agent_memory_values', ['user_id'], unique=False)
    op.create_table('ai_tenant_columns',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('uuid', sa.String(length=36), nullable=False),
    sa.Column('table_id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=63), nullable=False, comment='列名，必须符合PostgreSQL标识符规范'),
    sa.Column('label', sa.String(length=255), nullable=True, comment='在UI中展示的友好名称'),
    sa.Column('description', sa.Text(), nullable=True, comment='该列的详细描述或帮助文本'),
    sa.Column('data_type', sa.Enum('TEXT', 'NUMBER', 'INTEGER', 'BOOLEAN', 'TIMESTAMP', 'JSON', name='tenantdatatype'), nullable=False),
    sa.Column('is_primary_key', sa.Boolean(), nullable=False),
    sa.Column('is_nullable', sa.Boolean(), nullable=False),
    sa.Column('is_unique', sa.Boolean(), nullable=False),
    sa.Column('is_indexed', sa.Boolean(), nullable=False, comment='是否为该列创建索引以加速查询'),
    sa.Column('default_value', sa.JSON(), nullable=True, comment="类型安全的默认值 (e.g., 123, 'abc', true)"),
    sa.Column('is_vector_enabled', sa.Boolean(), nullable=False, comment='是否为该列启用向量嵌入和检索'),
    sa.ForeignKeyConstraint(['table_id'], ['ai_tenant_tables.id'], name=op.f('fk_ai_tenant_columns_table_id_ai_tenant_tables'), ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_ai_tenant_columns')),
    sa.UniqueConstraint('table_id', 'name', name='uq_tenant_table_column_name')
    )
    op.create_index(op.f('ix_ai_tenant_columns_table_id'), 'ai_tenant_columns', ['table_id'], unique=False)
    op.create_index(op.f('ix_ai_tenant_columns_uuid'), 'ai_tenant_columns', ['uuid'], unique=True)
    op.create_table('billing_transactions',
    sa.Column('id', sa.Integer(), nullable=False, comment='交易唯一主键ID'),
    sa.Column('uuid', sa.String(length=36), nullable=False, comment='交易的全局唯一、可对外暴露的ID'),
    sa.Column('billing_account_id', sa.Integer(), nullable=False, comment='关联的计费账户ID'),
    sa.Column('amount', sa.DECIMAL(precision=18, scale=8), nullable=False, comment='交易金额'),
    sa.Column('type', sa.Enum('DEBIT', 'CREDIT', name='transactiontype'), nullable=False, comment='交易类型 (借项/扣费, 贷项/充值)'),
    sa.Column('status', sa.Enum('PENDING', 'COMPLETED', 'FAILED', 'REFUNDED', name='transactionstatus'), nullable=False, comment='交易状态'),
    sa.Column('description', sa.String(length=255), nullable=False, comment="对用户展示的交易描述 (e.g., 'Agent 执行用量 - 2023-10-28', 'Pro套餐月度订阅')"),
    sa.Column('source_record_id', sa.Integer(), nullable=True, comment='[用量] 产生此费用的源头ConsumptionRecord ID，用于审计'),
    sa.Column('source_product_id', sa.Integer(), nullable=True, comment='[订阅] 关联的产品ID'),
    sa.Column('source_payment_id', sa.String(length=255), nullable=True, comment='[充值] 关联的支付网关支付ID'),
    sa.Column('context', sa.JSON(), nullable=True, comment='其他元数据，如退款原因、管理员操作备注等'),
    sa.Column('transaction_date', sa.DateTime(), server_default=sa.text('now()'), nullable=False, comment='交易发生（被记录）的时间'),
    sa.ForeignKeyConstraint(['billing_account_id'], ['billing_accounts.id'], name=op.f('fk_billing_transactions_billing_account_id_billing_accounts')),
    sa.ForeignKeyConstraint(['source_product_id'], ['products.id'], name=op.f('fk_billing_transactions_source_product_id_products')),
    sa.ForeignKeyConstraint(['source_record_id'], ['consumption_records.id'], name=op.f('fk_billing_transactions_source_record_id_consumption_records')),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_billing_transactions'))
    )
    op.create_index(op.f('ix_billing_transactions_billing_account_id'), 'billing_transactions', ['billing_account_id'], unique=False)
    op.create_index(op.f('ix_billing_transactions_source_record_id'), 'billing_transactions', ['source_record_id'], unique=False)
    op.create_index(op.f('ix_billing_transactions_status'), 'billing_transactions', ['status'], unique=False)
    op.create_index(op.f('ix_billing_transactions_transaction_date'), 'billing_transactions', ['transaction_date'], unique=False)
    op.create_index(op.f('ix_billing_transactions_type'), 'billing_transactions', ['type'], unique=False)
    op.create_index(op.f('ix_billing_transactions_uuid'), 'billing_transactions', ['uuid'], unique=True)
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_billing_transactions_uuid'), table_name='billing_transactions')
    op.drop_index(op.f('ix_billing_transactions_type'), table_name='billing_transactions')
    op.drop_index(op.f('ix_billing_transactions_transaction_date'), table_name='billing_transactions')
    op.drop_index(op.f('ix_billing_transactions_status'), table_name='billing_transactions')
    op.drop_index(op.f('ix_billing_transactions_source_record_id'), table_name='billing_transactions')
    op.drop_index(op.f('ix_billing_transactions_billing_account_id'), table_name='billing_transactions')
    op.drop_table('billing_transactions')
    op.drop_index(op.f('ix_ai_tenant_columns_uuid'), table_name='ai_tenant_columns')
    op.drop_index(op.f('ix_ai_tenant_columns_table_id'), table_name='ai_tenant_columns')
    op.drop_table('ai_tenant_columns')
    op.drop_index(op.f('ix_ai_agent_memory_values_user_id'), table_name='ai_agent_memory_values')
    op.drop_index(op.f('ix_ai_agent_memory_values_session_uuid'), table_name='ai_agent_memory_values')
    op.drop_index(op.f('ix_ai_agent_memory_values_memory_id'), table_name='ai_agent_memory_values')
    op.drop_table('ai_agent_memory_values')
    op.drop_table('price_tiers')
    op.drop_table('knowledge_base_version_documents')
    op.drop_index(op.f('ix_entitlement_balances_status'), table_name='entitlement_balances')
    op.drop_index(op.f('ix_entitlement_balances_owner_user_id'), table_name='entitlement_balances')
    op.drop_index(op.f('ix_entitlement_balances_owner_team_id'), table_name='entitlement_balances')
    op.drop_index(op.f('ix_entitlement_balances_feature_id'), table_name='entitlement_balances')
    op.drop_table('entitlement_balances')
    op.drop_index(op.f('ix_consumption_records_user_id'), table_name='consumption_records')
    op.drop_index(op.f('ix_consumption_records_trace_span_id'), table_name='consumption_records')
    op.drop_index(op.f('ix_consumption_records_status'), table_name='consumption_records')
    op.drop_index(op.f('ix_consumption_records_feature_id'), table_name='consumption_records')
    op.drop_index(op.f('ix_consumption_records_billing_account_id'), table_name='consumption_records')
    op.drop_table('consumption_records')
    op.drop_index(op.f('ix_ai_uiapp_pages_app_version_id'), table_name='ai_uiapp_pages')
    op.drop_table('ai_uiapp_pages')
    op.drop_index(op.f('ix_ai_tenant_tables_uuid'), table_name='ai_tenant_tables')
    op.drop_index(op.f('ix_ai_tenant_tables_tenantdb_id'), table_name='ai_tenant_tables')
    op.drop_table('ai_tenant_tables')
    op.drop_index(op.f('ix_ai_chat_messages_uuid'), table_name='ai_chat_messages')
    op.drop_index(op.f('ix_ai_chat_messages_trace_id'), table_name='ai_chat_messages')
    op.drop_index(op.f('ix_ai_chat_messages_session_id'), table_name='ai_chat_messages')
    op.drop_index(op.f('ix_ai_chat_messages_is_deleted'), table_name='ai_chat_messages')
    op.drop_table('ai_chat_messages')
    op.drop_index(op.f('ix_ai_agent_memories_agent_id'), table_name='ai_agent_memories')
    op.drop_table('ai_agent_memories')
    op.drop_index(op.f('ix_traces_user_id'), table_name='traces')
    op.drop_index(op.f('ix_traces_trace_id'), table_name='traces')
    op.drop_index(op.f('ix_traces_target_instance_id'), table_name='traces')
    op.drop_index(op.f('ix_traces_status'), table_name='traces')
    op.drop_index(op.f('ix_traces_span_uuid'), table_name='traces')
    op.drop_index(op.f('ix_traces_source_instance_id'), table_name='traces')
    op.drop_index(op.f('ix_traces_processed_at'), table_name='traces')
    op.drop_index(op.f('ix_traces_parent_span_uuid'), table_name='traces')
    op.drop_index(op.f('ix_traces_operation_name'), table_name='traces')
    op.drop_index(op.f('ix_traces_created_at'), table_name='traces')
    op.drop_index(op.f('ix_traces_context_type'), table_name='traces')
    op.drop_index(op.f('ix_traces_context_id'), table_name='traces')
    op.drop_index(op.f('ix_traces_api_key_id'), table_name='traces')
    op.drop_table('traces')
    op.drop_index(op.f('ix_team_members_uuid'), table_name='team_members')
    op.drop_table('team_members')
    op.drop_index(op.f('ix_product_entitlements_product_id'), table_name='product_entitlements')
    op.drop_index(op.f('ix_product_entitlements_feature_id'), table_name='product_entitlements')
    op.drop_table('product_entitlements')
    op.drop_table('prices')
    op.drop_index(op.f('ix_memberships_uuid'), table_name='memberships')
    op.drop_index(op.f('ix_memberships_user_id'), table_name='memberships')
    op.drop_index(op.f('ix_memberships_status'), table_name='memberships')
    op.drop_table('memberships')
    op.drop_index(op.f('ix_membership_history_user_id'), table_name='membership_history')
    op.drop_table('membership_history')
    op.drop_table('ai_workflows')
    op.drop_table('ai_uiapps')
    op.drop_table('ai_tools')
    op.drop_index(op.f('ix_ai_tenant_dbs_schema_name'), table_name='ai_tenant_dbs')
    op.drop_table('ai_tenant_dbs')
    op.drop_index(op.f('ix_ai_resource_refs_target_resource_id'), table_name='ai_resource_refs')
    op.drop_index(op.f('ix_ai_resource_refs_target_instance_id'), table_name='ai_resource_refs')
    op.drop_index(op.f('ix_ai_resource_refs_source_resource_id'), table_name='ai_resource_refs')
    op.drop_index(op.f('ix_ai_resource_refs_source_node_uuid'), table_name='ai_resource_refs')
    op.drop_index(op.f('ix_ai_resource_refs_source_instance_id'), table_name='ai_resource_refs')
    op.drop_table('ai_resource_refs')
    op.drop_index(op.f('ix_ai_knowledge_bases_engine_alias'), table_name='ai_knowledge_bases')
    op.drop_index(op.f('ix_ai_knowledge_bases_collection_name'), table_name='ai_knowledge_bases')
    op.drop_table('ai_knowledge_bases')
    op.drop_index(op.f('ix_ai_chat_sessions_uuid'), table_name='ai_chat_sessions')
    op.drop_index(op.f('ix_ai_chat_sessions_user_id'), table_name='ai_chat_sessions')
    op.drop_index(op.f('ix_ai_chat_sessions_is_archived'), table_name='ai_chat_sessions')
    op.drop_index(op.f('ix_ai_chat_sessions_agent_instance_id'), table_name='ai_chat_sessions')
    op.drop_table('ai_chat_sessions')
    op.drop_table('ai_agents')
    op.drop_index(op.f('ix_ai_agent_context_summaries_uuid'), table_name='ai_agent_context_summaries')
    op.drop_index(op.f('ix_ai_agent_context_summaries_user_id'), table_name='ai_agent_context_summaries')
    op.drop_index(op.f('ix_ai_agent_context_summaries_trace_id'), table_name='ai_agent_context_summaries')
    op.drop_index(op.f('ix_ai_agent_context_summaries_session_uuid'), table_name='ai_agent_context_summaries')
    op.drop_index(op.f('ix_ai_agent_context_summaries_scope'), table_name='ai_agent_context_summaries')
    op.drop_index(op.f('ix_ai_agent_context_summaries_ref_created_at'), table_name='ai_agent_context_summaries')
    op.drop_index(op.f('ix_ai_agent_context_summaries_is_archived'), table_name='ai_agent_context_summaries')
    op.drop_index(op.f('ix_ai_agent_context_summaries_agent_instance_id'), table_name='ai_agent_context_summaries')
    op.drop_table('ai_agent_context_summaries')
    op.drop_table('role_permissions')
    op.drop_table('products')
    op.drop_index(op.f('ix_invitations_uuid'), table_name='invitations')
    op.drop_index(op.f('ix_invitations_token'), table_name='invitations')
    op.drop_index(op.f('ix_invitations_target_identifier'), table_name='invitations')
    op.drop_index(op.f('ix_invitations_target_entity_id'), table_name='invitations')
    op.drop_table('invitations')
    op.drop_index(op.f('ix_assets_workspace_id'), table_name='assets')
    op.drop_index(op.f('ix_assets_uuid'), table_name='assets')
    op.drop_index(op.f('ix_assets_type'), table_name='assets')
    op.drop_index(op.f('ix_assets_status'), table_name='assets')
    op.drop_index(op.f('ix_assets_is_deleted'), table_name='assets')
    op.drop_index(op.f('ix_assets_folder_id'), table_name='assets')
    op.drop_index(op.f('ix_assets_content_hash'), table_name='assets')
    op.drop_table('assets')
    op.drop_index('ix_resource_workspace_status', table_name='ai_resource_instances', postgresql_where=sa.text("status = 'WORKSPACE'"))
    op.drop_index('ix_resource_instances_resource_created_at', table_name='ai_resource_instances')
    op.drop_index(op.f('ix_ai_resource_instances_version_tag'), table_name='ai_resource_instances')
    op.drop_index(op.f('ix_ai_resource_instances_uuid'), table_name='ai_resource_instances')
    op.drop_index(op.f('ix_ai_resource_instances_status'), table_name='ai_resource_instances')
    op.drop_index(op.f('ix_ai_resource_instances_resource_id'), table_name='ai_resource_instances')
    op.drop_index(op.f('ix_ai_resource_instances_parent_version_id'), table_name='ai_resource_instances')
    op.drop_index(op.f('ix_ai_resource_instances_linked_feature_id'), table_name='ai_resource_instances')
    op.drop_table('ai_resource_instances')
    op.drop_index(op.f('ix_ai_project_resource_refs_resource_id'), table_name='ai_project_resource_refs')
    op.drop_index(op.f('ix_ai_project_resource_refs_project_id'), table_name='ai_project_resource_refs')
    op.drop_table('ai_project_resource_refs')
    op.drop_index(op.f('ix_activity_logs_timestamp'), table_name='activity_logs')
    op.drop_index(op.f('ix_activity_logs_parent_id'), table_name='activity_logs')
    op.drop_index(op.f('ix_activity_logs_actor_user_id'), table_name='activity_logs')
    op.drop_index(op.f('ix_activity_logs_actor_team_id'), table_name='activity_logs')
    op.drop_index(op.f('ix_activity_logs_action_id'), table_name='activity_logs')
    op.drop_table('activity_logs')
    op.drop_index(op.f('ix_service_module_credentials_workspace_id'), table_name='service_module_credentials')
    op.drop_index(op.f('ix_service_module_credentials_uuid'), table_name='service_module_credentials')
    op.drop_index(op.f('ix_service_module_credentials_provider_id'), table_name='service_module_credentials')
    op.drop_table('service_module_credentials')
    op.drop_index(op.f('ix_roles_uuid'), table_name='roles')
    op.drop_index(op.f('ix_roles_parent_id'), table_name='roles')
    op.drop_table('roles')
    op.drop_index(op.f('ix_assets_folders_workspace_id'), table_name='assets_folders')
    op.drop_index(op.f('ix_assets_folders_uuid'), table_name='assets_folders')
    op.drop_index(op.f('ix_assets_folders_parent_id'), table_name='assets_folders')
    op.drop_index(op.f('ix_assets_folders_is_deleted'), table_name='assets_folders')
    op.drop_table('assets_folders')
    op.drop_index(op.f('ix_ai_resources_workspace_id'), table_name='ai_resources')
    op.drop_index(op.f('ix_ai_resources_uuid'), table_name='ai_resources')
    op.drop_index(op.f('ix_ai_resources_resource_type_id'), table_name='ai_resources')
    op.drop_index(op.f('ix_ai_resources_heat_value'), table_name='ai_resources')
    op.drop_index(op.f('ix_ai_resources_category_id'), table_name='ai_resources')
    op.drop_table('ai_resources')
    op.drop_index(op.f('ix_ai_projects_workspace_id'), table_name='ai_projects')
    op.drop_index(op.f('ix_ai_projects_uuid'), table_name='ai_projects')
    op.drop_table('ai_projects')
    op.drop_table('ai_api_policies')
    op.drop_table('service_module_dependencies')
    op.drop_index(op.f('ix_features_service_module_version_id'), table_name='features')
    op.drop_table('features')
    op.drop_table('api_keys')
    op.drop_index(op.f('ix_ai_workspaces_uuid'), table_name='ai_workspaces')
    op.drop_index(op.f('ix_ai_workspaces_owner_user_id'), table_name='ai_workspaces')
    op.drop_index(op.f('ix_ai_workspaces_owner_team_id'), table_name='ai_workspaces')
    op.drop_table('ai_workspaces')
    op.drop_index(op.f('ix_teams_uuid'), table_name='teams')
    op.drop_table('teams')
    op.drop_index(op.f('ix_service_module_versions_uuid'), table_name='service_module_versions')
    op.drop_index(op.f('ix_service_module_versions_status'), table_name='service_module_versions')
    op.drop_index(op.f('ix_service_module_versions_service_module_id'), table_name='service_module_versions')
    op.drop_table('service_module_versions')
    op.drop_table('payment_methods_credit_card')
    op.drop_table('payment_methods_alipay')
    op.drop_index(op.f('ix_users_uuid'), table_name='users')
    op.drop_index(op.f('ix_users_phone_number'), table_name='users')
    op.drop_index(op.f('ix_users_managing_entity_id'), table_name='users')
    op.drop_index(op.f('ix_users_email'), table_name='users')
    op.drop_index(op.f('ix_users_billing_account_id'), table_name='users')
    op.drop_table('users')
    op.drop_index(op.f('ix_service_modules_uuid'), table_name='service_modules')
    op.drop_index(op.f('ix_service_modules_provider_id'), table_name='service_modules')
    op.drop_table('service_modules')
    op.drop_index(op.f('ix_payment_methods_is_default'), table_name='payment_methods')
    op.drop_index(op.f('ix_payment_methods_billing_account_id'), table_name='payment_methods')
    op.drop_table('payment_methods')
    op.drop_index(op.f('ix_ai_knowledge_chunks_vector_id'), table_name='ai_knowledge_chunks')
    op.drop_index(op.f('ix_ai_knowledge_chunks_uuid'), table_name='ai_knowledge_chunks')
    op.drop_index(op.f('ix_ai_knowledge_chunks_status'), table_name='ai_knowledge_chunks')
    op.drop_index(op.f('ix_ai_knowledge_chunks_document_id'), table_name='ai_knowledge_chunks')
    op.drop_table('ai_knowledge_chunks')
    op.drop_table('service_module_types')
    op.drop_table('service_module_providers')
    op.drop_table('payment_gateways')
    op.drop_index(op.f('ix_billing_accounts_uuid'), table_name='billing_accounts')
    op.drop_index(op.f('ix_billing_accounts_status'), table_name='billing_accounts')
    op.drop_table('billing_accounts')
    op.drop_index(op.f('ix_assets_intelligence_is_vector_indexed'), table_name='assets_intelligence')
    op.drop_table('assets_intelligence')
    op.drop_index(op.f('ix_ai_workflow_node_defs_registry_id'), table_name='ai_workflow_node_defs')
    op.drop_index(op.f('ix_ai_workflow_node_defs_category'), table_name='ai_workflow_node_defs')
    op.drop_table('ai_workflow_node_defs')
    op.drop_table('ai_resource_types')
    op.drop_table('ai_resource_categories')
    op.drop_index(op.f('ix_ai_knowledge_documents_uuid'), table_name='ai_knowledge_documents')
    op.drop_index(op.f('ix_ai_knowledge_documents_status'), table_name='ai_knowledge_documents')
    op.drop_table('ai_knowledge_documents')
    op.drop_index(op.f('ix_action_permissions_type'), table_name='action_permissions')
    op.drop_index(op.f('ix_action_permissions_parent_id'), table_name='action_permissions')
    op.drop_table('action_permissions')
    # ### end Alembic commands ###
